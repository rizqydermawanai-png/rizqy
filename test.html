<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kalkulator HPP & Penjualan Kazumi</title>
    <!-- Tailwind CSS CDN untuk styling responsif dan modern -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js CDN untuk visualisasi data laporan -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
    <!-- Font Inter dari Google Fonts untuk konsistensi tipografi -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Menggunakan font Inter untuk seluruh elemen body */
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Menghilangkan panah (spin button) pada input tipe number */
        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type="number"] {
            -moz-appearance: textfield;
        }
        /* Efek bayangan kustom */
        .shadow-lg-custom {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .shadow-xl-custom {
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        /* Transisi untuk perpindahan tab yang lebih mulus */
        .tab-content {
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
            transform: translateY(10px);
            /* Tambahkan ini untuk memastikan konten tidak terlihat saat tidak aktif */
            position: absolute; /* Mengatasi masalah tinggi 0 */
            width: 100%;
            left: 0;
            top: 0;
        }
        .tab-content.active {
            opacity: 1;
            transform: translateY(0);
            position: static; /* Mengembalikan ke posisi normal saat aktif */
            height: auto;
            overflow: visible;
            display: block;
        }
        .tab-content:not(.active) {
            opacity: 0;
            height: 0;
            overflow: hidden;
            display: none;
        }

        /* Styling khusus untuk area cetak (nota/struk) */
        @media print {
            body > *:not(#print-area) { display: none !important; }
            #print-area {
                display: block !important;
                position: static !important; /* Perbaikan: Gunakan static untuk print */
                width: 100%;
                height: auto;
                margin: 0;
                padding: 0;
                box-shadow: none;
                background: white;
                overflow: visible;
            }
            #print-area, #print-area * {
                color: black !important;
                background-color: white !important;
            }
            #print-area table, #print-area th, #print-area td {
                border-color: #e5e7eb !important;
            }
        }
        /* Area cetak disembunyikan secara default */
        #print-area {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 9999;
            overflow-y: auto;
            padding: 2rem;
        }
        /* ==================== GLOBAL STYLES ==================== */
        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            font-family: 'Inter', sans-serif;
            background-attachment: fixed;
            background-size: cover;
        }
        /* Header dengan gambar background */
        #app-container {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.18);
        }
        /* Tab Navigasi */
        .tab-button {
            position: relative;
            padding: 10px 20px;
            font-weight: 600;
            color: #6b7280;
            transition: all 0.3s ease;
        }
        .tab-button.active {
            color: #4f46e5;
        }
        .tab-button.active::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            right: 0;
            height: 3px;
            background: #4f46e5;
            border-radius: 3px 3px 0 0;
        }
        /* Kartu (Cards) */
        .interactive-card {
            background: rgba(255, 255, 255, 0.7);
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.5);
            transition: all 0.3s ease;
        }
        .interactive-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 25px rgba(0, 0, 0, 0.1);
            background: rgba(255, 255, 255, 0.9);
        }
        /* Tombol */
        button, .button {
            background: linear-gradient(to right, #4f46e5, #7c3aed);
            color: white;
            border: none;
            border-radius: 10px;
            padding: 10px 20px;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        button:hover, .button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(79, 70, 229, 0.4);
        }
        /* Tombol Logout */
        #logoutBtn {
            background: linear-gradient(to right, #ef4444, #f87171);
        }
        /* Input fields */
        input, select, textarea {
            background: rgba(255, 255, 255, 0.8);
            border: 1px solid #e5e7eb;
            border-radius: 10px;
            padding: 10px 15px;
            transition: all 0.3s ease;
        }
        input:focus, select:focus, textarea:focus {
            border-color: #4f46e5;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.2);
            background: white;
        }
        /* Notifikasi */
        #notificationDropdown {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }
        /* Ikon */
        svg {
            transition: all 0.3s ease;
        }
    </style>
</head>
<body class="min-h-screen bg-gray-100 p-4 sm:p-8 flex flex-col items-center">
    <!-- Kontainer utama aplikasi -->
    <div id="app-container" class="bg-white p-6 sm:p-10 rounded-3xl shadow-xl-custom w-full max-w-6xl relative">
        <!-- Konten aplikasi akan dirender oleh JavaScript di sini -->
    </div>

    <!-- Modal untuk Catatan Revisi -->
    <div id="revisionModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full">
            <h3 class="text-xl font-bold mb-4">Revisi Laporan</h3>
            <p class="text-gray-700 mb-4">Tambahkan catatan revisi:</p>
            <textarea id="revisionNotesInput" class="w-full p-2 border rounded-md mb-4 h-24 resize-y" placeholder="Contoh: Perbaikan jumlah bahan..."></textarea>
            <div class="flex justify-end gap-3">
                <button id="cancelRevisionBtn" class="py-2 px-4 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">Batal</button>
                <button id="confirmRevisionBtn" class="py-2 px-4 bg-indigo-600 text-white rounded-md hover:bg-indigo-700">Kirim Revisi</button>
            </div>
        </div>
    </div>

    <!-- Area Cetak -->
    <div id="print-area">
        <!-- Konten nota akan dimasukkan secara dinamis di sini -->
    </div>

    <!-- Logika Aplikasi Utama -->
    <script type="module">
        // =====================================================================================================
        // BAGIAN 1: KONFIGURASI & DATA STATIS
        // =====================================================================================================

        const logoUrl = 'https://placehold.co/150x50?text=Logo'; // Placeholder untuk logo

        // Data Pengguna Awal (digunakan jika localStorage kosong)
        const DEFAULT_INITIAL_USERS = [
            { uid: 'kazumisp_uid', username: 'kazumisp', password: 'kazumisp', role: 'super_admin', department: null, isApproved: true, createdAt: new Date().toISOString(), email: 'superadmin@example.com', whatsapp: '6281234567890' },
            { uid: 'kazumiad_uid', username: 'kazumiad', password: 'kazumiad', role: 'admin', department: null, isApproved: true, createdAt: new Date().toISOString(), email: 'admin@example.example.com', whatsapp: '6281234567891' },
            { uid: 'kazumiproduksi_uid', username: 'produksi', password: 'produksi', role: 'member', department: 'produksi', isApproved: true, createdAt: new Date().toISOString(), email: 'produksi@example.com', whatsapp: '6281234567892' },
            { uid: 'kazumigudang_uid', username: 'gudang', password: 'gudang', role: 'member', department: 'gudang', isApproved: true, createdAt: new Date().toISOString(), email: 'gudang@example.com', whatsapp: '6281234567893' }
        ];

        // Ukuran Pakaian
        const GARMENT_SIZES = {
            kaos: {
                'Regular': { 'S': { bodyLength: 68, chestWidth: 48, sleeveLength: 22 }, 'M': { bodyLength: 70, chestWidth: 50, sleeveLength: 23 }, 'L': { bodyLength: 72, chestWidth: 52, sleeveLength: 24 }, 'XL': { bodyLength: 74, chestWidth: 54, sleeveLength: 25 }, 'XXL': { bodyLength: 76, chestWidth: 56, sleeveLength: 26 }, '2XL': { bodyLength: 78, chestWidth: 58, sleeveLength: 27 } },
                'Regular-Fit': { 'S': { bodyLength: 67, chestWidth: 47, sleeveLength: 21 }, 'M': { bodyLength: 69, chestWidth: 49, sleeveLength: 22 }, 'L': { bodyLength: 71, chestWidth: 51, sleeveLength: 23 }, 'XL': { bodyLength: 73, chestWidth: 53, sleeveLength: 24 }, 'XXL': { bodyLength: 75, chestWidth: 55, sleeveLength: 25 }, '2XL': { bodyLength: 77, chestWidth: 57, sleeveLength: 26 } },
                'Oversized': { 'S': { bodyLength: 70, chestWidth: 55, sleeveLength: 24 }, 'M': { bodyLength: 72, chestWidth: 57, sleeveLength: 25 }, 'L': { bodyLength: 74, chestWidth: 59, sleeveLength: 26 }, 'XL': { bodyLength: 76, chestWidth: 61, sleeveLength: 27 }, 'XXL': { bodyLength: 78, chestWidth: 63, sleeveLength: 28 }, '2XL': { bodyLength: 80, chestWidth: 65, sleeveLength: 29 } }
            },
            kemeja: { 'S': { bodyLength: 72, chestWidth: 50, sleeveLength: 58, collar: 38 }, 'M': { bodyLength: 74, chestWidth: 52, sleeveLength: 60, collar: 40 }, 'L': { bodyLength: 76, chestWidth: 54, sleeveLength: 62, collar: 42 }, 'XL': { bodyLength: 78, chestWidth: 56, sleeveLength: 64, collar: 44 }, 'XXL': { bodyLength: 80, chestWidth: 58, sleeveLength: 66, collar: 46 }, '2XL': { bodyLength: 82, chestWidth: 60, sleeveLength: 68, collar: 48 } },
            jaket: { 'S': { bodyLength: 65, chestWidth: 55, sleeveLength: 60, hood: 28 }, 'M': { bodyLength: 67, chestWidth: 57, sleeveLength: 62, hood: 29 }, 'L': { bodyLength: 69, chestWidth: 59, sleeveLength: 64, hood: 30 }, 'XL': { bodyLength: 71, chestWidth: 61, sleeveLength: 66, hood: 31 }, 'XXL': { bodyLength: 73, chestWidth: 63, sleeveLength: 68, hood: 32 }, '2XL': { bodyLength: 75, chestWidth: 65, sleeveLength: 70, hood: 33 } },
            celana: { 'S': { waist: 78, outseam: 95, inseam: 70 }, 'M': { waist: 82, outseam: 98, inseam: 73 }, 'L': { waist: 86, outseam: 101, inseam: 76 }, 'XL': { waist: 90, outseam: 104, inseam: 79 }, 'XXL': { waist: 94, outseam: 107, inseam: 82 }, '2XL': { waist: 98, outseam: 110, inseam: 85 } },
        };

        // Warna Standar untuk Dropdown
        const STANDARD_COLORS = [
            { name: 'Pilih Warna', hex: '' },
            { name: 'Hitam', hex: '#000000' },
            { name: 'Putih', hex: '#FFFFFF' },
            { name: 'Merah', hex: '#FF0000' },
            { name: 'Biru', hex: '#0000FF' },
            { name: 'Hijau', hex: '#008000' },
            { name: 'Kuning', hex: '#FFFF00' },
            { name: 'Abu-abu', hex: '#808080' },
            { name: 'Navy', hex: '#000080' },
            { name: 'Maroon', hex: '#800000' },
            { name: 'Coklat', hex: '#A52A2A' },
            { name: 'Pink', hex: '#FFC0CB' },
            { name: 'Ungu', hex: '#800080' },
        ];

        // Pola Pakaian & Fungsi Perhitungan Area Bahan
        const GARMENT_PATTERNS = {
            kaos: {
                title: 'Kaos',
                icon: `<svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-shirt mx-auto"><path d="M20.38 3.46 16 2a4 4 0 0 1-8 0L3.62 3.46a2 2 0 0 0-1.34 2.23l.58 3.47a1 1 0 0 0 .99.84H6v10c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V10h2.15a1 1 0 0 0 .99-.84l.58-3.47a2 2 0 0 0-1.34-2.23z"></path></svg>`,
                models: ['Regular', 'Regular-Fit', 'Oversized', 'Boxy Oversize'],
                calculateMaterialArea: (details) => {
                    const bodyArea = 2 * (details.bodyLength / 100) * (details.chestWidth / 100);
                    const sleeveArea = 2 * (details.sleeveLength / 100) * (details.chestWidth / 100 * 0.5);
                    const neckbandArea = 0.05 * 0.6;
                    const additionalAllowance = 0.01;
                    return bodyArea + sleeveArea + neckbandArea + additionalAllowance;
                },
            },
            kemeja: {
                title: 'Kemeja',
                icon: `<svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-briefcase mx-auto"><path d="M16 20V4a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/><rect width="20" height="14" x="2" y="6" rx="2"/></svg>`,
                calculateMaterialArea: (details) => {
                    const bodyArea = 2 * (details.bodyLength / 100) * (details.chestWidth / 100);
                    const sleeveArea = 2 * (details.sleeveLength / 100) * (details.chestWidth / 100 * 0.4);
                    const collarArea = (details.collar / 100) * 0.15;
                    const cuffArea = 2 * (0.05 * 0.3);
                    const placketArea = 2 * (0.05 * (details.bodyLength / 100));
                    const yokeArea = (details.chestWidth / 100) * 0.2;
                    const additionalAllowance = 0.02;
                    return bodyArea + sleeveArea + collarArea + cuffArea + placketArea + yokeArea + additionalAllowance;
                },
            },
            jaket: {
                title: 'Jaket',
                icon: `<svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-jacket mx-auto"><path d="M2 10a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2Z"/><path d="M18 10V4a1 1 0 0 0-1-1H7a1 1 0 0 0-1 1v6"/><path d="M12 2v2"/><path d="M10 2h4"/></svg>`,
                calculateMaterialArea: (details) => {
                    const bodyArea = 2 * (details.bodyLength / 100) * (details.chestWidth / 100 * 1.1);
                    const sleeveArea = 2 * (details.sleeveLength / 100) * (details.chestWidth / 100 * 0.5);
                    const hoodArea = (details.hood / 100) * (details.chestWidth / 100 * 0.8);
                    const cuffRibbingArea = 2 * (0.08 * 0.4);
                    const waistbandArea = (details.chestWidth / 100) * 0.1;
                    const placketFacingArea = 2 * (details.bodyLength / 100) * 0.08;
                    const additionalAllowance = 0.05;
                    return bodyArea + sleeveArea + hoodArea + cuffRibbingArea + waistbandArea + placketFacingArea + additionalAllowance;
                },
            },
            celana: {
                title: 'Celana',
                icon: `<svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trousers mx-auto"><path d="M10 9V3H4a2 2 0 0 0-2 2v7c0 2.2 1.8 4 4 4h4"/><path d="M14 9V3h6a2 2 0 0 1 2 2v7c0 2.2-1.8 4-4 4h-4"/><path d="M9 18v3"/><path d="M15 18v3"/><path d="M12 16v-2"/></svg>`,
                calculateMaterialArea: (details) => {
                    const legArea = 4 * (details.outseam / 100) * (details.waist / 100 * 0.4);
                    const waistbandArea = (details.waist / 100) * 0.1;
                    const pocketArea = 4 * (0.2 * 0.2);
                    const flyArea = 0.1 * 0.2;
                    const beltLoopArea = 5 * (0.05 * 0.1);
                    const additionalAllowance = 0.03;
                    return legArea + waistbandArea + pocketArea + flyArea + beltLoopArea + additionalAllowance;
                },
            },
        };

        // =====================================================================================================
        // BAGIAN 2: UTILITIES (Fungsi Pembantu Umum)
        // =====================================================================================================

        /**
         * Memuat data dari localStorage.
         * @param {string} key - Kunci localStorage.
         * @param {*} defaultValue - Nilai default jika tidak ada data.
         * @returns {*} Data dari localStorage atau nilai default.
         */
        const loadFromLocalStorage = (key, defaultValue) => {
            try {
                const storedValue = localStorage.getItem(key);
                return storedValue ? JSON.parse(storedValue) : defaultValue;
            } catch (e) {
                console.error(`Error loading from localStorage for key "${key}":`, e);
                return defaultValue;
            }
        };

        /**
         * Menyimpan data ke localStorage.
         * @param {string} key - Kunci localStorage.
         * @param {*} data - Data yang akan disimpan.
         */
        const saveToLocalStorage = (key, data) => {
            try {
                localStorage.setItem(key, JSON.stringify(data));
            } catch (e) {
                console.error(`Error saving to localStorage for key "${key}":`, e);
            }
        };

        /**
         * Memformat angka menjadi format Rupiah.
         * @param {number} number - Angka yang akan diformat.
         * @returns {string} String Rupiah.
         */
        const formatRupiah = (number) => new Intl.NumberFormat('id-ID').format(Math.round(isNaN(number) || number === null ? 0 : number));

        /**
         * Memformat peran pengguna.
         * @param {string} role - Peran pengguna.
         * @returns {string} Nama peran yang diformat.
         */
        const formatRole = (role) => ({
            'super_admin': 'CEO',
            'admin': 'Wakil CEO',
            'user': 'Pengguna',
            'member': 'Anggota',
            'pending': 'Menunggu Persetujuan'
        }[role] || role);

        /**
         * Memformat nama departemen.
         * @param {string} dept - Nama departemen.
         * @returns {string} Nama departemen yang diformat.
         */
        const formatDepartment = (dept) => ({ 'produksi': 'Produksi', 'gudang': 'Gudang', 'penjualan': 'Penjualan' }[dept] || dept);

        /**
         * Menghasilkan ID unik sederhana.
         * @returns {string} ID unik.
         */
        const generateUniqueId = () => `id_${Date.now()}_${Math.random().toString(36).substring(2, 9)}`;

        /**
         * Mengambil username berdasarkan ID pengguna dari appState.allUsers.
         * @param {string} uid - ID pengguna.
         * @returns {string} Username atau UID yang dipotong jika tidak ditemukan.
         */
        function getUsernameById(uid) {
            if (!uid) return 'Tidak diketahui';
            const user = appState.allUsers.find(u => u.uid === uid);
            return user ? user.username : uid.substring(0, 8) + '...';
        }

        // =====================================================================================================
        // BAGIAN 3: UI FEEDBACK (Notifikasi, Modal, dll.)
        // =====================================================================================================

        /**
         * Menampilkan notifikasi pesan kustom.
         * @param {string} message - Pesan yang akan ditampilkan.
         * @param {'success'|'info'|'error'} type - Tipe pesan (menentukan warna dan ikon).
         */
        function showCustomMessage(message, type) {
            const messageBox = document.createElement('div');
            messageBox.className = `fixed top-4 right-4 p-4 rounded-lg shadow-lg text-white z-[10000] flex items-center gap-2 ${type === 'success' ? 'bg-green-500' : (type === 'info' ? 'bg-blue-500' : 'bg-red-500')}`;
            let iconSvg = '';
            if (type === 'success') {
                iconSvg = `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-check-circle"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><path d="m9 11 3 3L22 4"/></svg>`;
            } else if (type === 'info') {
                iconSvg = `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-info"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></svg>`;
            } else { // error
                iconSvg = `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x-circle"><circle cx="12" cy="12" r="10"/><path d="m15 9-6 6"/><path d="m9 9 6 6"/></svg>`;
            }
            messageBox.innerHTML = `${iconSvg}<span>${message}</span>`;
            document.body.appendChild(messageBox);
            setTimeout(() => messageBox.remove(), 3000);
        }

        /**
         * Menampilkan dialog konfirmasi kustom.
         * @param {string} message - Pesan konfirmasi.
         * @param {function} onConfirm - Fungsi callback yang akan dieksekusi jika dikonfirmasi.
         */
        function showCustomConfirmation(message, onConfirm) {
            const modalOverlay = document.createElement('div');
            modalOverlay.className = `fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[10000]`;
            modalOverlay.innerHTML = `
                <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full text-center">
                    <p class="text-lg font-semibold mb-4">${message}</p>
                    <div class="flex justify-center gap-4">
                        <button id="confirmYesBtn" class="py-2 px-4 bg-red-500 text-white rounded-md hover:bg-red-600">Ya</button>
                        <button id="confirmNoBtn" class="py-2 px-4 bg-gray-300 text-gray-800 rounded-md hover:bg-gray-400">Tidak</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modalOverlay);

            const confirmYesBtn = document.getElementById('confirmYesBtn');
            const confirmNoBtn = document.getElementById('confirmNoBtn');

            const cleanup = () => modalOverlay.remove();

            confirmYesBtn?.addEventListener('click', () => {
                onConfirm();
                cleanup();
            });
            confirmNoBtn?.addEventListener('click', cleanup);
        }

        /**
         * Alias untuk showCustomMessage dengan tipe 'info'.
         * @param {string} message - Pesan yang akan ditampilkan.
         * @param {'success'|'info'|'error'} type - Tipe pesan.
         */
        function showNotification(message, type = 'info') {
            showCustomMessage(message, type);
        }

        /**
         * Menampilkan modal generik dengan judul dan konten kustom.
         * @param {string} title - Judul modal.
         * @param {string} content - Konten HTML dari body modal.
         */
        function showModal(title, content) {
            const modalOverlay = document.createElement('div');
            modalOverlay.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[10000]';
            modalOverlay.innerHTML = `
                <div class="bg-white p-6 rounded-lg shadow-xl max-w-md w-full">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold">${title}</h3>
                        <button id="closeModalBtn" class="text-gray-500 hover:text-gray-700">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
                        </button>
                    </div>
                    <div class="modal-content">${content}</div>
                </div>
            `;
            document.body.appendChild(modalOverlay);
            document.getElementById('closeModalBtn')?.addEventListener('click', () => modalOverlay.remove());
        }

        /**
         * Menampilkan pesan error khusus untuk form login/register.
         * @param {string} message - Pesan error yang akan ditampilkan.
         */
        function showLoginErrorMessage(message) {
            const errorMessageDiv = document.getElementById('errorMessage');
            if (errorMessageDiv) {
                errorMessageDiv.querySelector('span').textContent = message;
                errorMessageDiv.classList.remove('hidden');
            }
        }

        // =====================================================================================================
        // BAGIAN 4: STATE MANAGEMENT (appState & Fungsi Modifikasi)
        // =====================================================================================================

        // Muat pengguna yang sedang login
        let loggedInUser = loadFromLocalStorage('loggedInUser', null);

        // Objek state aplikasi tunggal
        let appState = {
            userId: loggedInUser?.uid || null,
            username: loggedInUser?.username || null,
            userRole: loggedInUser?.role || null,
            userDepartment: loggedInUser?.department || null,
            isAuthReady: !!loggedInUser,
            isLoading: false,
            loginView: 'login',
            activeTab: 'production', // Default tab after login changed to 'production'
            activeProductionSubTab: 'hpp-calculator', // New sub-tab for production
            selectedGarment: 'kaos',
            materialInputType: 'length',
            garmentOrder: [], // Akan diinisialisasi di DOMContentLoaded
            material: loadFromLocalStorage('kazumiMaterialSettings', { length: 10, weight: 0, width: 45, shape: 'tubular', gramasi: 150, pricePerMeter: 40000, pricePerKg: 0, wasteFactor: 15, rollCount: 0, lengthPerRoll: 0, pricePerRoll: 0 }),
            otherCosts: loadFromLocalStorage('kazumiOtherCostsSettings', { laborCost: 10000, overheadCost: 1000, additionalItems: [{ name: 'Benang', cost: 2000, quantity: 1 }] }),
            profitPercentage: loadFromLocalStorage('kazumiProfitPercentage', 30),
            hppResult: null,
            showError: false,
            showWarning: false,
            salesCalculator: {
                items: [],
                customerName: '',
                discountType: 'percentage',
                discountValue: 0,
                taxPercentage: 0,
                result: null,
                searchTerm: '',
                selectedCategoryFilter: 'all'
            },
            warehouse: {
                inventory: loadFromLocalStorage('kazumiInventory', []),
                searchTerm: '',
                selectedCategoryFilter: 'all',
                lowStockThreshold: 10,
                stockHistory: loadFromLocalStorage('kazumiStockHistory', []),
                productionRequests: loadFromLocalStorage('kazumiProductionRequests', []),
                activeSubTab: 'inventory-list', // Default sub-tab for warehouse
                selectedStockStatusFilter: 'all'
            },
            activeReportTab: 'reports-list',
            savedReports: loadFromLocalStorage('kazumiHPPReports', []),
            savedSales: loadFromLocalStorage('kazumiSales', []),
            filteredReports: [], // Akan diisi oleh filterReports()
            filteredSales: [],   // Akan diisi oleh filterReports()
            selectedReport: null,
            selectedSale: null,
            startDate: '',
            endDate: '',
            allUsers: loadFromLocalStorage('kazumiLocalUsers', DEFAULT_INITIAL_USERS),
            pendingUsers: [], // Akan diisi setelah allUsers dimuat
            isCurrentlyRevising: false,
            originalReportIdForRevision: null,
            revisionNotesForNewReport: '',
            lastLoggedInUsers: loadFromLocalStorage('kazumiLastLoggedInUsers', []),
            activityLogs: loadFromLocalStorage('kazumiActivityLogs', []),
            currentProductionRequestId: null
        };

        // Inisialisasi daftar pengguna yang menunggu persetujuan
        appState.pendingUsers = appState.allUsers.filter(u => u.role === 'pending');

        /**
         * Memperbarui state aplikasi dan memicu render ulang jika diperlukan.
         * @param {object} newValues - Objek berisi properti state yang akan diperbarui.
         * @param {boolean} [shouldRender=true] - Apakah harus memicu render ulang UI.
         */
        function updateAppState(newValues, shouldRender = true) {
            Object.assign(appState, newValues);

            // Perbarui pendingUsers jika allUsers berubah
            if (newValues.allUsers) {
                appState.pendingUsers = appState.allUsers.filter(u => u.role === 'pending');
            }

            saveAllRelevantState(); // Simpan ke localStorage setelah setiap update
            if (shouldRender) {
                window.renderApp(); // Panggil fungsi render utama
            }
        }

        /**
         * Menyimpan semua bagian appState yang relevan ke localStorage.
         */
        function saveAllRelevantState() {
            saveToLocalStorage('kazumiHPPReports', appState.savedReports);
            saveToLocalStorage('kazumiSales', appState.savedSales);
            saveToLocalStorage('kazumiInventory', appState.warehouse.inventory);
            saveToLocalStorage('kazumiStockHistory', appState.warehouse.stockHistory);
            saveToLocalStorage('kazumiProductionRequests', appState.warehouse.productionRequests);
            saveToLocalStorage('kazumiActivityLogs', appState.activityLogs);
            saveToLocalStorage('kazumiLocalUsers', appState.allUsers);
            saveToLocalStorage('kazumiLastLoggedInUsers', appState.lastLoggedInUsers);
            saveToLocalStorage('kazumiMaterialSettings', appState.material);
            saveToLocalStorage('kazumiOtherCostsSettings', appState.otherCosts);
            saveToLocalStorage('kazumiProfitPercentage', appState.profitPercentage);

            filterReports(); // Panggil filterReports setelah menyimpan laporan
        }

        /**
         * Menambahkan entri log aktivitas.
         * @param {string} type - Tipe aktivitas (misal: 'Produksi', 'Penjualan', 'Gudang', 'Manajemen Akun').
         * @param {string} description - Deskripsi aktivitas.
         * @param {string} userId - ID pengguna yang melakukan aktivitas.
         * @param {string} [relatedId=null] - ID opsional dari laporan/penjualan/item terkait.
         */
        function addActivityLog(type, description, userId, relatedId = null) {
            const newLog = {
                id: generateUniqueId(),
                timestamp: new Date().toISOString(),
                type: type,
                description: description,
                userId: userId,
                relatedId: relatedId
            };
            const updatedLogs = [newLog, ...appState.activityLogs].slice(0, 100); // Pertahankan 100 log terbaru
            updateAppState({ activityLogs: updatedLogs }, false); // Update state tanpa render ulang segera
        }

        /**
         * Memfilter laporan dan penjualan berdasarkan rentang tanggal dan peran pengguna.
         */
        function filterReports() {
            const start = appState.startDate ? new Date(appState.startDate) : null;
            const end = appState.endDate ? new Date(appState.endDate) : null;
            if (end) end.setHours(23, 59, 59, 999);

            const filterPredicate = (item) => {
                const itemDate = new Date(item.timestamp);
                const dateMatch = (!start || itemDate >= start) && (!end || itemDate <= end);

                if (appState.userRole === 'admin' || appState.userRole === 'super_admin') {
                    return dateMatch;
                } else {
                    return dateMatch && item.userId === appState.userId;
                }
            };

            appState.filteredReports = appState.savedReports.filter(filterPredicate);
            appState.filteredSales = appState.savedSales.filter(filterPredicate);

            appState.filteredReports.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            appState.filteredSales.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
        }

        // =====================================================================================================
        // BAGIAN 5: RENDER FUNCTIONS (Komponen UI)
        // =====================================================================================================

        const appContainer = document.getElementById('app-container');
        let currentChart = null; // Variabel untuk menyimpan instance chart aktif

        /**
         * Fungsi render utama yang memutuskan layar mana yang akan ditampilkan (autentikasi atau aplikasi utama).
         */
        window.renderApp = function() {
            if (!appState.isAuthReady) {
                renderAuthScreen();
            } else {
                renderMainAppLayout();
            }
            attachEventListeners(); // Event listeners akan dilampirkan setelah render selesai
        };

        /**
         * Merender layar autentikasi (login/register).
         */
        function renderAuthScreen() {
            appContainer.innerHTML = `
                <div class="bg-white p-6 sm:p-10 rounded-3xl shadow-lg-custom w-full max-w-md mx-auto">
                    <h1 class="text-3xl sm:text-4xl font-bold text-center text-gray-800 mb-6">${appState.loginView === 'login' ? 'Login KAZUMI' : 'Daftar Akun Baru'}</h1>
                    <p class="text-center text-gray-600 mb-8">${appState.loginView === 'login' ? 'Silakan login untuk melanjutkan.' : 'Daftar untuk membuat akun baru.'}</p>
                    <div id="authForm" class="space-y-6">
                        ${appState.loginView === 'login' ? `
                            <div>
                                <label for="usernameInput" class="block text-sm font-medium text-gray-700 mb-1">User ID</label>
                                <input type="text" id="usernameInput" placeholder="Masukkan User ID Anda" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-3 border" />
                            </div>
                            <div>
                                <label for="passwordInput" class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                                <input type="password" id="passwordInput" placeholder="********" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-3 border" />
                            </div>
                            ${appState.lastLoggedInUsers.length > 0 ? `
                                <div class="mt-4">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Akun Terakhir Digunakan:</label>
                                    <div class="flex flex-wrap gap-2">
                                        ${appState.lastLoggedInUsers.map(user => `
                                            <button class="last-user-btn py-1 px-3 bg-gray-100 text-gray-700 rounded-md text-sm hover:bg-gray-200" data-username="${user.username}">${user.username}</button>
                                        `).join('')}
                                    </div>
                                </div>
                            ` : ''}
                        ` : `
                            <div><label for="regUsernameInput" class="block text-sm font-medium text-gray-700 mb-1">User ID</label><input type="text" id="regUsernameInput" placeholder="Pilih User ID" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-3 border" /></div>
                            <div><label for="regPasswordInput" class="block text-sm font-medium text-gray-700 mb-1">Password</label><input type="password" id="regPasswordInput" placeholder="Minimal 6 karakter" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-3 border" /></div>
                            <div><label for="regEmailInput" class="block text-sm font-medium text-gray-700 mb-1">Email</label><input type="email" id="regEmailInput" placeholder="contoh@domain.com" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-3 border" /></div>
                            <div><label for="regWhatsappInput" class="block text-sm font-medium text-gray-700 mb-1">Nomor WhatsApp</label><input type="tel" id="regWhatsappInput" placeholder="contoh: 628123456789" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-3 border" /></div>
                            <div><label for="regDepartmentInput" class="block text-sm font-medium text-gray-700 mb-1">Departemen</label><select id="regDepartmentInput" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-3 border"><option value="produksi">Produksi</option><option value="gudang">Gudang</option><option value="penjualan">Penjualan</option></select></div>
                        `}
                        <div id="errorMessage" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-md relative" role="alert"><strong class="font-bold">Error!</strong> <span class="block sm:inline"></span></div>
                        ${appState.loginView === 'login' ? `
                            <button id="loginBtn" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-xl shadow-lg-custom hover:bg-indigo-700">Login</button>
                            <button id="switchToRegisterBtn" class="w-full mt-4 bg-gray-200 text-gray-800 font-bold py-3 px-4 rounded-xl shadow-lg-custom hover:bg-gray-300">Daftar Akun Baru</button>
                        ` : `
                            <button id="registerBtn" class="w-full bg-green-600 text-white font-bold py-3 px-4 rounded-xl shadow-lg-custom hover:bg-green-700">Daftar</button>
                            <button id="switchToLoginBtn" class="w-full mt-4 bg-gray-200 text-gray-800 font-bold py-3 px-4 rounded-xl shadow-lg-custom hover:bg-gray-300">Kembali ke Login</button>
                        `}
                    </div>
                </div>
            `;
        }

        /**
         * Merender layout aplikasi utama dengan tab dan informasi pengguna.
         */
        function renderMainAppLayout() {
            const { userRole, userDepartment } = appState;
            const isAdmin = userRole === 'admin' || userRole === 'super_admin';
            const isSuperAdmin = userRole === 'super_admin';

            const visibleTabs = {
                production: isAdmin || userDepartment === 'produksi',
                salesCalculator: isAdmin || userDepartment === 'penjualan',
                report: isAdmin || userDepartment === 'produksi' || userDepartment === 'penjualan' || userDepartment === 'gudang',
                warehouse: isAdmin || userDepartment === 'gudang',
                accountManagement: isAdmin,
                activityLogs: isSuperAdmin,
            };

            // Definisikan urutan tab berdasarkan departemen
            let tabOrder = [];
            if (userDepartment === 'gudang') {
                tabOrder = ['warehouse', 'report', 'production', 'salesCalculator', 'accountManagement'];
            } else if (userDepartment === 'produksi') {
                tabOrder = ['production', 'report', 'warehouse', 'salesCalculator', 'accountManagement'];
            } else if (userDepartment === 'penjualan') {
                tabOrder = ['salesCalculator', 'report', 'production', 'warehouse', 'accountManagement'];
            } else if (isAdmin) { // Urutan default Admin/Super Admin
                tabOrder = ['production', 'salesCalculator', 'report', 'warehouse', 'accountManagement'];
            }
            if (isSuperAdmin) {
                tabOrder.push('activityLogs');
            }

            const tabButtonsHtml = tabOrder.map(tabKey => {
                if (visibleTabs[tabKey]) {
                    const tabTitleMap = {
                        production: 'Produksi',
                        salesCalculator: 'Kalkulator Penjualan',
                        report: 'Laporan',
                        warehouse: 'Gudang',
                        accountManagement: 'Manajemen Akun',
                        activityLogs: 'Aktivitas Kerja'
                    };
                    return `<button id="${tabKey}TabBtn" class="py-2 px-4 font-semibold ${appState.activeTab === tabKey ? 'border-b-2 border-indigo-600 text-indigo-600' : 'text-gray-500 hover:text-indigo-600'}">${tabTitleMap[tabKey]}</button>`;
                }
                return '';
            }).join('');

            appContainer.innerHTML = `
                <h1 class="text-3xl sm:text-4xl font-bold text-center text-gray-800 mb-2">Dasbor KAZUMI</h1>
                <p class="text-center text-gray-600 mb-8">Manajemen Produksi, Penjualan, dan Inventaris Anda.</p>
                <div class="mb-4 text-center text-gray-500 text-sm flex items-center justify-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-user"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                    User ID: <span class="font-mono text-gray-700">${appState.username}</span> |
                    <span class="font-semibold text-indigo-600">${formatRole(userRole) || formatDepartment(userDepartment)}</span>
                    <button id="logoutBtn" class="ml-4 py-1 px-3 bg-red-100 text-red-600 rounded-md text-sm font-medium hover:bg-red-200">Logout</button>
                </div>

                <div class="flex flex-wrap justify-center border-b border-gray-200 mb-8">
                    ${tabButtonsHtml}
                </div>

                <div class="relative min-h-[600px]"> <!-- Tambahkan min-h untuk mencegah layout bergeser -->
                    <div id="productionSection" class="tab-content ${appState.activeTab === 'production' ? 'active' : ''}">${visibleTabs.production ? renderProductionContent() : ''}</div>
                    <div id="salesCalculatorSection" class="tab-content ${appState.activeTab === 'salesCalculator' ? 'active' : ''}">${visibleTabs.salesCalculator ? renderSalesCalculatorContent() : ''}</div>
                    <div id="warehouseSection" class="tab-content ${appState.activeTab === 'warehouse' ? 'active' : ''}">${visibleTabs.warehouse ? renderWarehouseContent() : ''}</div>
                    <div id="reportSection" class="tab-content ${appState.activeTab === 'report' ? 'active' : ''}">${visibleTabs.report ? renderReportContent() : ''}</div>
                    <div id="accountManagementSection" class="tab-content ${appState.activeTab === 'accountManagement' ? 'active' : ''}">${visibleTabs.accountManagement ? renderAccountManagementContent() : ''}</div>
                    <div id="activityLogsSection" class="tab-content ${appState.activeTab === 'activityLogs' ? 'active' : ''}">${visibleTabs.activityLogs ? renderActivityLogsContent() : ''}</div>
                </div>
            `;

            // Render konten spesifik untuk tab aktif
            if (appState.activeTab === 'production' && visibleTabs.production) {
                renderProductionSubContent();
            } else if (appState.activeTab === 'report' && visibleTabs.report) {
                renderReportSubContent();
            } else if (appState.activeTab === 'warehouse' && visibleTabs.warehouse) {
                renderWarehouseSubContent();
            }
        }

        /**
         * Merender konten untuk tab Produksi (pengganti Kalkulator HPP).
         * @returns {string} String HTML untuk konten produksi.
         */
        function renderProductionContent() {
            return `
                <div class="p-6 bg-white rounded-2xl shadow-sm border border-gray-200">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">Manajemen Produksi</h2>
                    <div class="flex flex-wrap space-x-2 border-b border-gray-300 mb-6">
                        <button id="hppCalculatorSubTabBtn" class="py-2 px-4 text-sm font-semibold ${appState.activeProductionSubTab === 'hpp-calculator' ? 'border-b-2 border-indigo-600 text-indigo-600' : 'text-gray-500 hover:text-indigo-600'}">Kalkulator HPP</button>
                        <button id="productionRequestsSubTabBtn" class="py-2 px-4 text-sm font-semibold ${appState.activeProductionSubTab === 'production-requests' ? 'border-b-2 border-indigo-600 text-indigo-600' : 'text-gray-500 hover:text-indigo-600'}">Permintaan Gudang</button>
                    </div>
                    <div id="productionSubContent">
                        <!-- Sub-konten akan dirender di sini oleh renderProductionSubContent() -->
                    </div>
                </div>
            `;
        }

        /**
         * Merender sub-konten yang sesuai untuk tab Produksi berdasarkan `appState.activeProductionSubTab`.
         */
        function renderProductionSubContent() {
            const productionSubContentContainer = document.getElementById('productionSubContent');
            if (!productionSubContentContainer) return;

            if (appState.activeProductionSubTab === 'hpp-calculator') {
                productionSubContentContainer.innerHTML = renderHPPCalculatorContent();
                renderGarmentSelection();
                renderMaterialInputFields();
                renderGarmentOrderList();
                renderAdditionalItems();
                if (appState.hppResult) renderHPPResult();
            } else if (appState.activeProductionSubTab === 'production-requests') {
                productionSubContentContainer.innerHTML = renderProductionRequests('production-tab');
            }
        }

        /**
         * Merender konten kalkulator HPP yang sebenarnya.
         * @returns {string} String HTML untuk konten kalkulator HPP.
         */
        function renderHPPCalculatorContent() {
            return `
                ${appState.isCurrentlyRevising ? `<div class="bg-blue-100 border border-blue-400 text-blue-800 px-4 py-3 rounded-xl mb-6 flex items-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-edit-3"><path d="M12 20h9"/><path d="M16.5 3.5a2.12 2.12 0 0 1 3 3L7 19l-4 1 1-4Z"/><path d="m15 5-3 3"/></svg><span class="font-semibold">Anda sedang merevisi laporan. Catatan: "${appState.revisionNotesForNewReport}"</span></div>` : ''}
                <div class="p-6 bg-gray-50 rounded-2xl mb-8 flex flex-col items-center">
                    <h2 class="text-2xl font-bold mb-6 text-gray-700 flex items-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-shirt mx-auto"><path d="M20.38 3.46 16 2a4 4 0 0 1-8 0L3.62 3.46a2 2 0 0 0-1.34 2.23l.58 3.47a1 1 0 0 0 .99.84H6v10c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V10h2.15a1 1 0 0 0 .99-.84l.58-3.47a2 2 0 0 0-1.34-2.23z"></path></svg>Pilih Jenis Pakaian</h2>
                    <div id="garmentSelection" class="grid grid-cols-2 sm:grid-cols-4 gap-6 w-full max-w-2xl"></div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div class="space-y-6">
                        <div class="p-6 bg-white rounded-2xl shadow-sm border border-gray-200">
                            <h3 class="text-lg font-semibold mb-4 flex items-center gap-2 text-indigo-600"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-ruler"><path d="M21.3 15.3a2.4 2.4 0 0 1 0 3.4l-2.6 2.6a2.4 2.4 0 0 1-3.4 0L2.7 8.7a2.41 2.41 0 0 1 0-3.4l2.6-2.6a2.41 2.41 0 0 1 3.4 0Z"/><path d="m14.5 12.5 2-2"/><path d="m11.5 9.5 2-2"/><path d="m8.5 6.5 2-2"/><path d="m17.5 15.5 2-2"/></svg>Detail Bahan</h3>
                            <div class="space-y-4">
                                <div><label for="materialWidth" class="block text-sm font-medium text-gray-700">Lebar Bahan (inch)</label><input type="number" id="materialWidth" value="${appState.material.width}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border"/></div>
                                <div><label for="wasteFactor" class="block text-sm font-medium text-gray-700">Faktor Limbah (%)</label><input type="number" min="0" max="100" id="wasteFactor" value="${appState.material.wasteFactor}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border"/></div>
                                <div><label class="block text-sm font-medium text-gray-700">Bentuk Bahan</label><div class="flex gap-4 mt-1"><button id="shapeTubularBtn" class="flex-1 py-2 px-4 rounded-md font-medium transition-colors ${appState.material.shape === 'tubular' ? 'bg-indigo-600 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}">Tubular (Sarung)</button><button id="shapeOpenWideBtn" class="flex-1 py-2 px-4 rounded-md font-medium transition-colors ${appState.material.shape === 'open-wide' ? 'bg-indigo-600 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}">Open-Wide (Lembaran)</button></div></div>
                                <div><label class="block text-sm font-medium text-gray-700">Metode Input Bahan</label><div class="flex gap-4 mt-1"><button id="inputLengthBtn" class="flex-1 py-2 px-4 rounded-md font-medium transition-colors ${appState.materialInputType === 'length' ? 'bg-indigo-600 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}">Panjang (m)</button><button id="inputWeightBtn" class="flex-1 py-2 px-4 rounded-md font-medium transition-colors ${appState.materialInputType === 'weight' ? 'bg-indigo-600 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}">Berat (kg)</button><button id="inputRollBtn" class="flex-1 py-2 px-4 rounded-md font-medium transition-colors ${appState.materialInputType === 'roll' ? 'bg-indigo-600 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}">Rol Bahan</button></div></div>
                                <div id="materialInputFields"></div>
                            </div>
                        </div>
                        <div class="p-4 bg-white rounded-2xl shadow-sm border border-gray-200">
                            <div class="flex justify-between items-center mb-4"><h3 class="text-lg font-semibold flex items-center gap-2 text-indigo-600"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-pie-chart"><path d="M21.21 15.89A10 10 0 1 1 8 2.83"/><path d="M22 12A10 10 0 0 0 12 2v10z"/></svg>Detail Pesanan</h3><button id="addGarmentItemBtn" class="py-1 px-2 bg-indigo-100 text-indigo-600 rounded-md text-xs font-medium hover:bg-indigo-200 flex items-center gap-1"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-plus-circle"><circle cx="12" cy="12" r="10"/><path d="M8 12h8"/><path d="M12 8v8"/></svg>Tambah Item</button></div>
                            <div id="garmentOrderList" class="space-y-3"></div>
                        </div>
                        <div class="p-6 bg-white rounded-2xl shadow-sm border border-gray-200">
                            <h3 class="text-lg font-semibold mb-4 flex items-center gap-2 text-indigo-600"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-factory"><path d="M2 20a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v2H2v-2Z"/><path d="M6 15V4a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v11a1 1 0 0 1-1 1H7a1 1 0 0 1-1-1Z"/><path d="M14 15V4a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v11a1 1 0 0 1-1 1h-2a1 1 0 0 1-1-1Z"/></svg>Biaya Lain-lain</h3>
                            <div class="space-y-4">
                                <div><label for="laborCost" class="block text-sm font-medium text-gray-700">Biaya Tenaga Kerja per Pcs (Rp)</label><input type="number" id="laborCost" value="${appState.otherCosts.laborCost}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border"/></div>
                                <div><label for="overheadCost" class="block text-sm font-medium text-gray-700">Biaya Overhead per Pcs (Rp)</label><input type="number" id="overheadCost" value="${appState.otherCosts.overheadCost}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border"/></div>
                                <div class="pt-4 border-t border-gray-200"><div class="flex justify-between items-center mb-2"><h4 class="text-sm font-semibold text-gray-700">Biaya Tambahan</h4><button id="addAdditionalItemBtn" class="py-1 px-2 bg-indigo-100 text-indigo-600 rounded-md text-xs font-medium hover:bg-indigo-200 flex items-center gap-1"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-plus-circle"><circle cx="12" cy="12" r="10"/><path d="M8 12h8"/><path d="M12 8v8"/></svg>Tambah</button></div><div id="additionalItemsList" class="space-y-3"></div></div>
                            </div>
                        </div>
                    </div>
                    <div class="space-y-6">
                        <div class="p-6 bg-white rounded-2xl shadow-sm border border-gray-200">
                            <h3 class="text-lg font-semibold mb-4 flex items-center gap-2 text-indigo-600"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trending-up"><polyline points="22 7 13.5 15.5 8.5 10.5 2 17"/><polyline points="16 7 22 7 22 13"/></svg>Proyeksi Keuntungan</h3>
                            <div><label for="profitPercentage" class="block text-sm font-medium text-gray-700">Persentase Keuntungan (%)</label><input type="number" id="profitPercentage" value="${appState.profitPercentage}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border"/></div>
                        </div>
                        <div class="p-6 bg-white rounded-2xl shadow-sm border border-gray-200">
                            <h3 class="text-lg font-semibold mb-4 flex items-center gap-2 text-indigo-600"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-lightbulb"><path d="M15 14c.2-1 .7-1.7 1.5-2.5 1-.9 1.5-2.2 1.5-3.5A6 6 0 0 0 6 6c0 1.8.7 3.3 1.5 4.5C9.2 12.2 12 14 12 14"/><path d="M12 18.5V22H4l2-2.5C7 18 9 16.5 9 16c0-1.4-.5-2.8-1.5-3.5M2 14h2"/><path d="M20 14h2"/><path d="M9.5 17.5 12 22"/><path d="M14.5 17.5 12 22"/></svg>Rekomendasi Proyeksi Keuntungan</h3>
                            <div class="space-y-4 text-sm text-gray-700">
                                <div><h4 class="font-bold text-gray-800">1. Rendah (1% - 15%)</h4><p class="mt-1 text-gray-600">Cocok untuk strategi harga terendah dengan volume penjualan besar.</p></div>
                                <div><h4 class="font-bold text-gray-800">2. Sedang (16% - 40%)</h4><p class="mt-1 text-gray-600">Rentang ideal untuk merek lokal yang menyeimbangkan harga dan kualitas.</p></div>
                                <div><h4 class="font-bold text-gray-800">3. Tinggi (41% - 70%)</h4><p class="mt-1 text-gray-600">Untuk brand premium, kualitas tinggi, atau desain yang unik dan eksklusif.</p></div>
                                <div><h4 class="font-bold text-gray-800">4. Sangat Tinggi (71% - 100%)</h4><p class="mt-1 text-gray-600">Berlaku untuk produk sangat kustom, barang mewah, atau karya desainer dengan nilai seni tinggi.</p></div>
                            </div>
                        </div>
                        <div class="p-6 bg-white rounded-2xl shadow-sm border border-gray-200">
                            <button id="calculateHPPBtn" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-xl shadow-lg-custom hover:bg-indigo-700 transition-all transform hover:scale-105">Hitung HPP</button>
                            <div id="errorMessage" class="mt-4 p-3 bg-red-100 border border-red-400 text-red-700 text-sm rounded-xl items-start gap-2 ${appState.showError ? 'flex' : 'hidden'}"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-alert-triangle mt-0.5"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><path d="M12 9v4"/><path d="M12 17h.01"/></svg><p>Mohon lengkapi semua input dengan nilai yang valid (lebih dari 0).</p></div>
                        </div>
                        <div id="hppResultSection" class="p-6 bg-white rounded-2xl shadow-lg-custom border border-gray-200 ${appState.hppResult ? '' : 'hidden'}"></div>
                    </div>
                </div>
            `;
        }

        /**
         * Merender tombol pemilihan garmen.
         */
        function renderGarmentSelection() {
            const container = document.getElementById('garmentSelection');
            if (!container) return;
            container.innerHTML = '';
            Object.entries(GARMENT_PATTERNS).forEach(([id, { title, icon }]) => {
                const button = document.createElement('button');
                button.className = `flex flex-col items-center justify-center p-6 rounded-2xl transition-all duration-300 transform hover:scale-105 shadow-md ${appState.selectedGarment === id ? 'bg-indigo-600 text-white' : 'bg-white text-gray-700 hover:bg-gray-100'}`;
                button.innerHTML = `${icon}<span class="mt-3 font-semibold text-lg">${title}</span>`;
                button.dataset.garmentId = id;
                container.appendChild(button);
            });
        }

        /**
         * Merender bidang input bahan berdasarkan tipe input yang dipilih (panjang/berat/rol).
         */
        function renderMaterialInputFields() {
            const container = document.getElementById('materialInputFields');
            if (!container) return;
            container.innerHTML = '';
            const createInputGroup = (labelText, inputId, value, placeholder = '') => {
                const div = document.createElement('div');
                div.innerHTML = `<label for="${inputId}" class="block text-sm font-medium text-gray-700">${labelText}</label><input type="number" id="${inputId}" value="${value}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border" ${placeholder ? `placeholder="${placeholder}"` : ''}/>`;
                return div;
            };
            if (appState.materialInputType === 'length') {
                container.appendChild(createInputGroup('Panjang Bahan (m)', 'materialLength', appState.material.length));
                container.appendChild(createInputGroup('Gramasi Bahan (gsm)', 'materialGramasi', appState.material.gramasi));
                container.appendChild(createInputGroup('Harga Bahan per Meter (Rp)', 'pricePerMeter', appState.material.pricePerMeter));
            } else if (appState.materialInputType === 'roll') {
                container.appendChild(createInputGroup('Jumlah Rol Bahan', 'materialRollCount', appState.material.rollCount || 0));
                container.appendChild(createInputGroup('Panjang per Rol (m)', 'materialLengthPerRoll', appState.material.lengthPerRoll || 0));
                container.appendChild(createInputGroup('Gramasi Bahan (gsm)', 'materialGramasi', appState.material.gramasi));
                container.appendChild(createInputGroup('Harga Bahan per Rol (Rp)', 'pricePerRoll', appState.material.pricePerRoll || 0));
            } else {
                container.appendChild(createInputGroup('Berat Bahan (kg)', 'materialWeight', appState.material.weight));
                container.appendChild(createInputGroup('Gramasi Bahan (gsm)', 'materialGramasi', appState.material.gramasi));
                container.appendChild(createInputGroup('Harga Bahan per Kg (Rp)', 'pricePerKg', appState.material.pricePerKg));
            }
        }

        /**
         * Merender daftar pesanan garmen.
         */
        function renderGarmentOrderList() {
            const container = document.getElementById('garmentOrderList');
            if (!container) return;
            container.innerHTML = '';
            const currentPattern = GARMENT_PATTERNS[appState.selectedGarment];

            appState.garmentOrder.forEach((item, index) => {
                const itemDiv = document.createElement('div');
                itemDiv.className = "bg-gray-50 p-3 rounded-xl shadow-sm border border-gray-200";

                const modelSelectHTML = currentPattern.models ? `
                    <div class="mb-2">
                        <label class="block text-xs font-medium text-gray-600">Model</label>
                        <select class="model-select mt-1 block w-full rounded-md border-gray-300 shadow-sm p-1.5 text-xs" data-id="${item.id}">
                            ${currentPattern.models.map(model => `<option value="${model}" ${item.model === model ? 'selected' : ''}>${model}</option>`).join('')}
                        </select>
                    </div>` : '';

                const selectedModelForSize = item.model || (currentPattern.models && currentPattern.models.length > 0 ? currentPattern.models[0] : undefined);
                const sizeOptions = GARMENT_SIZES[appState.selectedGarment]?.[selectedModelForSize] || GARMENT_SIZES[appState.selectedGarment] || {};
                const sizeSelectHTML = `
                    <select class="size-select mt-1 block w-full rounded-md border-gray-300 shadow-sm p-1.5 text-xs" data-id="${item.id}">
                        ${Object.keys(sizeOptions).map(size => `<option value="${size}" ${item.size === size ? 'selected' : ''}>${size}</option>`).join('')}
                    </select>`;

                const detailInputsHTML = Object.entries(item.details).map(([key, value]) => {
                    const label = key.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase());
                    return `
                        <div>
                            <label class="block text-xs font-medium text-gray-600 truncate">${label} (cm)</label>
                            <input type="number" value="${value}" class="detail-input mt-1 block w-full rounded-md border-gray-300 shadow-sm p-1.5 text-xs" data-id="${item.id}" data-detail-id="${key}"/>
                        </div>`;
                }).join('');

                const colorOptionsHTML = STANDARD_COLORS.map(color => `
                    <option value="${color.name}" data-hex="${color.hex}" ${item.color === color.name ? 'selected' : ''}>${color.name}</option>
                `).join('');

                const colorInputHTML = `
                    <div>
                        <label class="block text-xs font-medium text-gray-600">Warna</label>
                        <select class="color-select mt-1 block w-full rounded-md border-gray-300 shadow-sm p-1.5 text-xs" data-id="${item.id}">
                            ${colorOptionsHTML}
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-600">Kode Warna (HEX)</label>
                        <input type="text" value="${item.colorHex || ''}" placeholder="#RRGGBB" class="color-hex-input mt-1 block w-full rounded-md border-gray-300 shadow-sm p-1.5 text-xs" data-id="${item.id}"/>
                    </div>
                `;

                itemDiv.innerHTML = `
                    <div class="flex justify-between items-center mb-2">
                        <p class="font-semibold text-sm text-gray-800">Item #${index + 1}</p>
                        <button class="remove-item-btn text-red-500 hover:text-red-700 transition-colors" title="Hapus item" data-id="${item.id}">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trash-2"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>
                        </button>
                    </div>
                    ${modelSelectHTML}
                    <div class="grid grid-cols-2 gap-2 mb-2">
                        <div><label class="block text-xs font-medium text-gray-600">Ukuran</label>${sizeSelectHTML}</div>
                        <div><label class="block text-xs font-medium text-gray-600">Jumlah (pcs)</label><input type="number" min="1" value="${item.quantity}" class="quantity-input mt-1 block w-full rounded-md border-gray-300 shadow-sm p-1.5 text-xs" data-id="${item.id}"/></div>
                    </div>
                    <div class="grid grid-cols-2 gap-2 mb-2">
                        ${colorInputHTML}
                    </div>
                    <div class="mt-2 border-t border-gray-200 pt-2">
                        <p class="text-sm font-medium text-gray-700 mb-1">Detail Ukuran (cm)</p>
                        <div class="grid grid-cols-2 gap-2">${detailInputsHTML}</div>
                    </div>
                `;
                container.appendChild(itemDiv);
            });
        }

        /**
         * Merender daftar item biaya tambahan.
         */
        function renderAdditionalItems() {
            const container = document.getElementById('additionalItemsList');
            if (!container) return;
            container.innerHTML = '';
            appState.otherCosts.additionalItems.forEach((item, index) => {
                const itemDiv = document.createElement('div');
                itemDiv.className = "flex gap-2 items-center";
                itemDiv.innerHTML = `
                    <input type="text" placeholder="Nama Item" value="${item.name}" class="item-name-input w-1/2 rounded-md border-gray-300 shadow-sm p-2 border text-sm" data-index="${index}"/>
                    <input type="number" placeholder="Biaya" value="${item.cost}" class="item-cost-input w-1/4 rounded-md border-gray-300 shadow-sm p-2 border text-sm" data-index="${index}"/>
                    <input type="number" placeholder="Jumlah" value="${item.quantity}" class="item-quantity-input w-1/4 rounded-md border-gray-300 shadow-sm p-1.5 text-sm" data-index="${index}"/>
                    <button class="remove-additional-item-btn text-red-500 hover:text-red-700" title="Hapus item" data-index="${index}">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
                    </button>`;
                container.appendChild(itemDiv);
            });
        }

        /**
         * Merender bagian hasil perhitungan HPP.
         */
        function renderHPPResult() {
            const container = document.getElementById('hppResultSection');
            if (!container || !appState.hppResult) return;

            const { totalHPP, sellingPricePerGarment, profitPerGarment, garmentsProduced, materialCost, materialNeededPerGarmentCm } = appState.hppResult;

            container.innerHTML = `
                <h3 class="text-xl font-bold mb-4 text-gray-800">Hasil Perhitungan</h3>
                <div id="warningMessage" class="mb-4 p-3 bg-yellow-100 border border-yellow-400 text-yellow-700 text-sm rounded-xl items-start gap-2 ${appState.showWarning ? 'flex' : 'hidden'}">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-alert-triangle mt-0.5"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><path d="M12 9v4"/><path d="M12 17h.01"/></svg>
                    <p>Perhatian: Bahan yang tersedia tidak cukup. Perhitungan tetap ditampilkan berdasarkan kebutuhan.</p>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 mb-6">
                    <div class="bg-indigo-50 p-4 rounded-xl shadow-sm">
                        <p class="text-sm text-gray-600">HPP per Pcs</p>
                        <p class="text-xl font-bold text-indigo-700">Rp ${formatRupiah(totalHPP)}</p>
                    </div>
                    <div class="bg-green-50 p-4 rounded-xl shadow-sm">
                        <p class="text-sm text-gray-600">Harga Jual per Pcs</p>
                        <p class="text-xl font-bold text-green-700">Rp ${formatRupiah(sellingPricePerGarment)}</p>
                    </div>
                    <div class="bg-green-50 p-4 rounded-xl shadow-sm">
                        <p class="text-sm text-gray-600">Keuntungan per Pcs</p>
                        <p class="text-xl font-bold text-green-700">Rp ${formatRupiah(profitPerGarment)}</p>
                    </div>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div class="p-4 bg-gray-50 rounded-xl shadow-sm">
                        <p class="text-sm text-gray-600">Jumlah Produksi</p>
                        <p class="text-xl font-bold text-gray-700">${garmentsProduced} pcs</p>
                    </div>
                    <div class="p-4 bg-gray-50 rounded-xl shadow-sm">
                        <p class="text-sm text-gray-600">Total Biaya Bahan</p>
                        <p class="text-xl font-bold text-gray-700">Rp ${formatRupiah(materialCost)}</p>
                    </div>
                    <div class="p-4 bg-gray-50 rounded-xl shadow-sm col-span-full">
                        <p class="text-sm text-gray-600">Kebutuhan Bahan per Pcs</p>
                        <p class="text-xl font-bold text-gray-700">${materialNeededPerGarmentCm.toFixed(2)} cm</p>
                    </div>
                </div>
                <div id="materialVisualizer" class="mt-4 p-4 bg-gray-50 rounded-xl shadow-inner">${renderMaterialVisualizer()}</div>
                <button id="saveReportBtn" class="w-full mt-6 bg-green-600 text-white font-bold py-3 px-4 rounded-xl shadow-md hover:bg-green-700 transition-colors flex items-center justify-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-save"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>
                    ${appState.isCurrentlyRevising ? 'Simpan Revisi' : 'Simpan Laporan'}
                </button>
            `;
        }

        /**
         * Merender visualizer penggunaan bahan.
         * @returns {string} String HTML untuk visualizer bahan.
         */
        function renderMaterialVisualizer() {
            if (!appState.hppResult || !appState.material) return '';

            const effectiveWidthInMeters = (appState.material.width * (appState.material.shape === 'tubular' ? 2 : 1)) * 0.0254;
            const totalMaterialNeededLength = (appState.hppResult.totalRawAreaM2 * (1 + appState.hppResult.wasteFactor / 100)) / effectiveWidthInMeters;

            let totalMaterialAvailable = 0;
            if (appState.materialInputType === 'length') {
                totalMaterialAvailable = appState.material.length;
            } else if (appState.materialInputType === 'roll') {
                totalMaterialAvailable = appState.material.rollCount * appState.material.lengthPerRoll;
            } else {
                const areaPerKg = 1000 / appState.material.gramasi;
                const lengthPerKg = areaPerKg / effectiveWidthInMeters;
                totalMaterialAvailable = (appState.material.weight * lengthPerKg);
            }

            appState.showWarning = totalMaterialNeededLength > totalMaterialAvailable;

            const maxBarLength = Math.max(totalMaterialAvailable, totalMaterialNeededLength, 1);
            const availablePercentage = (totalMaterialAvailable / maxBarLength) * 100;
            const neededPercentage = (totalMaterialNeededLength / maxBarLength) * 100;

            const shortageAmount = (totalMaterialNeededLength - totalMaterialAvailable).toFixed(2);
            const surplusAmount = (totalMaterialAvailable - totalMaterialNeededLength).toFixed(2);

            return `
                <h4 class="text-sm font-semibold text-gray-700 flex items-center gap-1">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-scissors"><circle cx="6" cy="7" r="3"/><path d="M8.12 8.12 12 12"/><path d="M20 4 8.12 15.88"/><line x1="14.47" x2="20" y1="14.47" y2="20"/><circle cx="6" cy="17" r="3"/><path d="M8.12 15.88 12 12"/></svg>
                    Visualisasi Penggunaan Bahan
                </h4>
                <div class="space-y-4 my-4">
                    <div>
                        <div class="flex justify-between items-center text-xs font-medium text-gray-700">
                            <span>Bahan Tersedia:</span><span>${totalMaterialAvailable.toFixed(2)} m</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-4">
                            <div class="bg-green-500 h-full rounded-full" style="width: ${availablePercentage}%;"></div>
                        </div>
                    </div>
                    <div>
                        <div class="flex justify-between items-center text-xs font-medium text-gray-700">
                            <span>Bahan Dibutuhkan:</span><span>${totalMaterialNeededLength.toFixed(2)} m</span>
                        </div>
                        <div class="w-full h-4 rounded-full ${appState.showWarning ? 'bg-red-500' : 'bg-indigo-500'}" style="width: ${neededPercentage}%;"></div>
                    </div>
                </div>
                ${appState.showWarning ? `
                    <div class="p-3 bg-red-100 text-red-700 text-sm rounded-xl flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-alert-triangle mt-0.5"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><path d="M12 9v4"/><path d="M12 17h.01"/></svg>
                        <span>Kekurangan bahan sebesar <span class="font-bold">${shortageAmount} m</span>.</span>
                    </div>` : `
                    <div class="p-3 bg-green-100 text-green-700 text-sm rounded-xl flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-check-circle-2"><path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z"/><path d="m9 12 2 2 4-4"/></svg>
                        <span>Sisa bahan sebesar <span class="font-bold">${surplusAmount} m</span>.</span>
                    </div>`}
            `;
        }

        /**
         * Merender konten untuk tab Kalkulator Penjualan.
         * @returns {string} String HTML untuk konten kalkulator penjualan.
         */
        function renderSalesCalculatorContent() {
            const { items, customerName, discountType, discountValue, taxPercentage, result, searchTerm, selectedCategoryFilter } = appState.salesCalculator;
            const filteredInventory = appState.warehouse.inventory.filter(item =>
                item.stock > 0 &&
                item.name.toLowerCase().includes(searchTerm.toLowerCase()) &&
                (selectedCategoryFilter === 'all' || item.category === selectedCategoryFilter)
            );

            const garmentCategories = Object.values(GARMENT_PATTERNS).map(p => ({ id: p.title.toLowerCase(), name: p.title }));

            return `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <!-- Kolom Kiri: Input Penjualan -->
                    <div class="space-y-6">
                        <div class="p-6 bg-white rounded-2xl shadow-sm border border-gray-200">
                            <h3 class="text-lg font-semibold mb-4 flex items-center gap-2 text-green-600">
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-shopping-cart"><circle cx="8" cy="21" r="1"/><circle cx="19" cy="21" r="1"/><path d="M2.05 2.05h2l2.66 12.42a2 2 0 0 0 2 1.58h9.78a2 2 0 0 0 1.95-1.57l1.65-7.43H5.16"/></svg>
                                Item Penjualan
                            </h3>
                            <!-- Pencarian dan Filter Produk -->
                            <div class="flex flex-col sm:flex-row gap-2 mb-4">
                                <input type="text" id="salesProductSearch" placeholder="Cari produk..." value="${searchTerm}" class="p-2 border rounded-md flex-1">
                                <select id="salesCategoryFilter" class="p-2 border rounded-md">
                                    <option value="all">Semua Kategori</option>
                                    ${garmentCategories.map(cat => `<option value="${cat.id}" ${selectedCategoryFilter === cat.id ? 'selected' : ''}>${cat.name}</option>`).join('')}
                                </select>
                            </div>
                            <!-- Pemilihan Produk dari Gudang -->
                            <div class="flex gap-2 items-end">
                                <div class="flex-1">
                                    <label for="productSelect" class="block text-sm font-medium text-gray-700">Pilih Produk dari Gudang</label>
                                    <select id="productSelect" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500 p-2 border">
                                        ${filteredInventory.length > 0 ? filteredInventory.map(item => `<option value="${item.id}">${item.name} (Stok: ${item.stock}) - Rp ${formatRupiah(item.sellingPrice)}</option>`).join('') : '<option disabled>Tidak ada produk yang cocok</option>'}
                                    </select>
                                </div>
                                <button id="addProductToSaleBtn" class="py-2 px-4 bg-green-600 text-white rounded-md hover:bg-green-700" ${filteredInventory.length === 0 ? 'disabled' : ''}>Tambah</button>
                            </div>
                            <!-- Daftar Item yang Akan Dijual -->
                            <div id="saleItemsList" class="mt-4 space-y-2">
                                ${items.map((item, index) => `
                                    <div class="p-3 bg-gray-50 rounded-lg flex justify-between items-center">
                                        <div>
                                            <p class="font-semibold">${item.name}</p>
                                            <p class="text-xs text-gray-500">Harga: Rp ${formatRupiah(item.price)}</p>
                                        </div>
                                        <div class="flex items-center gap-2">
                                            <input type="number" value="${item.quantity}" min="1" max="${item.maxStock}" class="sale-item-quantity w-16 p-1 border rounded-md text-center" data-index="${index}">
                                            <button class="remove-sale-item-btn text-red-500 hover:text-red-700" data-index="${index}">&times;</button>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>

                    <!-- Kolom Kanan: Detail & Hasil Penjualan -->
                    <div class="space-y-6">
                        <div class="p-6 bg-white rounded-2xl shadow-sm border border-gray-200">
                             <h3 class="text-lg font-semibold mb-4 flex items-center gap-2 text-green-600">
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-receipt-text"><path d="M4 2v20l2-1 2 1 2-1 2 1 2-1 2 1 2-1 2 1V2l-2 1-2-1-2 1-2-1-2 1-2-1-2 1Z"/><path d="M14 8H8"/><path d="M16 12H8"/><path d="M12 16H8"/></svg>
                                Detail Transaksi
                            </h3>
                            <div class="space-y-4">
                                <div><label for="customerName" class="block text-sm font-medium text-gray-700">Nama Pelanggan (Opsional)</label><input type="text" id="customerName" value="${customerName}" class="mt-1 block w-full rounded-md border-gray-300 p-2 border"/></div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Diskon</label>
                                    <div class="flex gap-2 mt-1">
                                        <select id="discountType" class="w-1/3 p-2 border rounded-md">
                                            <option value="percentage" ${discountType === 'percentage' ? 'selected' : ''}>%</option>
                                            <option value="fixed" ${discountType === 'fixed' ? 'selected' : ''}>Rp</option>
                                        </select>
                                        <input type="number" id="discountValue" value="${discountValue}" class="flex-1 p-2 border rounded-md"/>
                                    </div>
                                </div>
                                <div><label for="taxPercentage" class="block text-sm font-medium text-gray-700">Pajak (%)</label><input type="number" id="taxPercentage" value="${taxPercentage}" class="mt-1 block w-full rounded-md border-gray-300 p-2 border"/></div>
                            </div>
                        </div>
                        <div class="p-6 bg-white rounded-2xl shadow-sm border border-gray-200">
                            <button id="calculateSaleBtn" class="w-full bg-green-600 text-white font-bold py-3 px-4 rounded-xl shadow-lg-custom hover:bg-green-700 transition-all">
                                Hitung Total Penjualan
                            </button>
                        </div>
                        ${result ? `
                            <div class="p-6 bg-green-50 rounded-2xl shadow-lg-custom border border-green-200 space-y-3">
                                <h3 class="text-xl font-bold text-gray-800">Ringkasan Penjualan</h3>
                                <div class="flex justify-between text-sm"><span class="text-gray-600">Subtotal:</span><span class="font-medium">Rp ${formatRupiah(result.subtotal)}</span></div>
                                <div class="flex justify-between text-sm"><span class="text-gray-600">Diskon:</span><span class="font-medium text-red-600">- Rp ${formatRupiah(result.discountAmount)}</span></div>
                                <div class="flex justify-between text-sm"><span class="text-gray-600">Pajak (${result.taxPercentage}%):</span><span class="font-medium">+ Rp ${formatRupiah(result.taxAmount)}</span></div>
                                <div class="flex justify-between text-lg font-bold border-t pt-2 mt-2"><span class="text-green-700">Total Akhir:</span><span class="text-green-700">Rp ${formatRupiah(result.grandTotal)}</span></div>
                                <button id="finalizeSaleBtn" class="w-full mt-4 bg-blue-600 text-white font-bold py-3 px-4 rounded-xl shadow-md hover:bg-blue-700">Finalisasi & Cetak Struk</button>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
        }

        /**
         * Merender konten untuk tab Gudang.
         * @returns {string} String HTML untuk konten gudang.
         */
        function renderWarehouseContent() {
            return `
                <div class="p-6 bg-white rounded-2xl shadow-sm border border-gray-200">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">Manajemen Gudang</h2>
                    <div class="flex flex-wrap space-x-2 border-b border-gray-300 mb-6">
                        <button id="inventoryListTabBtn" class="py-2 px-4 text-sm font-semibold ${appState.warehouse.activeSubTab === 'inventory-list' ? 'border-b-2 border-indigo-600 text-indigo-600' : 'text-gray-500 hover:text-indigo-600'}">Inventaris</button>
                        <button id="productionRequestsWarehouseTabBtn" class="py-2 px-4 text-sm font-semibold ${appState.warehouse.activeSubTab === 'production-requests-warehouse' ? 'border-b-2 border-indigo-600 text-indigo-600' : 'text-gray-500 hover:text-indigo-600'}">Produk Masuk</button>
                        <button id="stockHistoryTabBtn" class="py-2 px-4 text-sm font-semibold ${appState.warehouse.activeSubTab === 'stock-history' ? 'border-b-2 border-indigo-600 text-indigo-600' : 'text-gray-500 hover:text-indigo-600'}">Rekap Stok</button>
                    </div>

                    <div id="warehouseSubContent">
                        <!-- Sub-konten akan dirender di sini oleh renderWarehouseSubContent() -->
                    </div>
                </div>
            `;
        }

        /**
         * Merender sub-konten yang sesuai untuk tab Gudang berdasarkan `appState.warehouse.activeSubTab`.
         */
        function renderWarehouseSubContent() {
            const warehouseSubContentContainer = document.getElementById('warehouseSubContent');
            if (!warehouseSubContentContainer) return;

            if (appState.warehouse.activeSubTab === 'inventory-list') {
                warehouseSubContentContainer.innerHTML = renderInventoryList();
            } else if (appState.warehouse.activeSubTab === 'stock-history') {
                warehouseSubContentContainer.innerHTML = renderStockHistory();
            } else if (appState.warehouse.activeSubTab === 'production-requests-warehouse') {
                warehouseSubContentContainer.innerHTML = renderProductionRequests('warehouse-tab');
            }
        }

        /**
         * Merender daftar inventaris untuk gudang.
         * @returns {string} String HTML untuk daftar inventaris.
         */
        function renderInventoryList() {
            const { inventory, searchTerm, selectedCategoryFilter, lowStockThreshold, selectedStockStatusFilter } = appState.warehouse;
            const filteredInventory = inventory.filter(item => {
                const matchesSearch = item.name.toLowerCase().includes(searchTerm.toLowerCase());
                const matchesCategory = (selectedCategoryFilter === 'all' || item.category === selectedCategoryFilter);
                const matchesStockStatus = (selectedStockStatusFilter === 'all' ||
                    (selectedStockStatusFilter === 'aman' && item.stock > lowStockThreshold) ||
                    (selectedStockStatusFilter === 'hampir-habis' && item.stock > 0 && item.stock <= lowStockThreshold) ||
                    (selectedStockStatusFilter === 'habis' && item.stock === 0)
                );
                return matchesSearch && matchesCategory && matchesStockStatus;
            });

            const garmentCategories = Object.values(GARMENT_PATTERNS).map(p => ({ id: p.title.toLowerCase(), name: p.title }));

            return `
                <div class="flex flex-col sm:flex-row justify-between items-center mb-4 gap-4">
                    <h3 class="text-xl font-bold text-gray-800">Inventaris Saat Ini</h3>
                    <div class="flex flex-col sm:flex-row gap-2 w-full sm:w-2/3">
                        <input type="text" id="warehouseSearch" placeholder="Cari nama produk..." value="${searchTerm}" class="p-2 border rounded-md flex-1">
                        <select id="categoryFilter" class="p-2 border rounded-md">
                            <option value="all">Semua Kategori</option>
                            ${garmentCategories.map(cat => `<option value="${cat.id}" ${selectedCategoryFilter === cat.id ? 'selected' : ''}>${cat.name}</option>`).join('')}
                        </select>
                        <select id="stockStatusFilter" class="p-2 border rounded-md">
                            <option value="all" ${selectedStockStatusFilter === 'all' ? 'selected' : ''}>Semua Stok</option>
                            <option value="aman" ${selectedStockStatusFilter === 'aman' ? 'selected' : ''}>Stok Aman</option>
                            <option value="hampir-habis" ${selectedStockStatusFilter === 'hampir-habis' ? 'selected' : ''}>Hampir Habis</option>
                            <option value="habis" ${selectedStockStatusFilter === 'habis' ? 'selected' : ''}>Habis</option>
                        </select>
                    </div>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                    ${filteredInventory.length > 0 ? filteredInventory.map(item => {
                        const statusClass = item.stock === 0 ? 'bg-red-100 text-red-800' : (item.stock <= lowStockThreshold ? 'bg-yellow-100 text-yellow-800' : 'bg-green-100 text-green-800');
                        const statusText = item.stock === 0 ? 'Habis' : (item.stock <= lowStockThreshold ? 'Hampir Habis' : 'Aman');
                        return `
                            <div class="bg-gray-50 p-4 rounded-xl shadow-sm border flex flex-col">
                                <div class="flex justify-between items-center mb-2">
                                    <h4 class="font-bold text-gray-900">${item.name}</h4>
                                    <span class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full ${statusClass}">${statusText}</span>
                                </div>
                                <p class="text-sm text-gray-600">Kategori: <span class="font-mono text-gray-800">${item.category.charAt(0).toUpperCase() + item.category.slice(1)}</span></p>
                                <p class="text-sm text-gray-600">Stok: <span class="font-mono text-gray-800">${item.stock} pcs</span></p>
                                <p class="text-sm text-gray-600">HPP: <span class="font-medium">Rp ${formatRupiah(item.hpp)}</span></p>
                                <p class="text-sm text-gray-600">Harga Jual: <span class="font-semibold text-green-700">Rp ${formatRupiah(item.sellingPrice)}</span></p>
                                <div class="mt-4 flex items-center gap-2">
                                    <button class="request-production-btn py-1 px-3 bg-blue-100 text-blue-700 rounded-md text-sm hover:bg-blue-200" data-id="${item.id}">Minta Produksi</button>
                                </div>
                            </div>
                        `;
                    }).join('') : `<div class="col-span-full text-center py-4 text-gray-500">Tidak ada item di gudang.</div>`}
                </div>
            `;
        }

        /**
         * Merender daftar riwayat stok untuk gudang.
         * @returns {string} String HTML untuk riwayat stok.
         */
        function renderStockHistory() {
            const { stockHistory, inventory } = appState;
            
            // Gabungkan data stok dengan informasi inventaris
            const stockWithStatus = stockHistory.map(entry => {
                const inventoryItem = inventory.find(item => item.id === entry.productId);
                let status = 'Aman';
                let statusClass = 'bg-green-100 text-green-800';
                
                if (inventoryItem) {
                    if (inventoryItem.stock === 0) {
                        status = 'Habis';
                        statusClass = 'bg-red-100 text-red-800';
                    } else if (inventoryItem.stock <= 10) {
                        status = 'Hampir Habis';
                        statusClass = 'bg-yellow-100 text-yellow-800';
                    }
                }
                
                return {
                    ...entry,
                    status,
                    statusClass,
                    productName: entry.productName,
                    category: inventoryItem ? inventoryItem.category : 'Tidak Diketahui'
                };
            });
            
            return `
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-gray-800">Rekap Keluar Masuk Stok</h3>
                    <button id="exportStockHistoryBtn" class="py-2 px-4 bg-green-600 text-white rounded-md hover:bg-green-700 flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                        Ekspor ke Excel
                    </button>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full bg-white">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="py-2 px-4 text-left text-xs font-medium text-gray-500 uppercase">Tanggal</th>
                                <th class="py-2 px-4 text-left text-xs font-medium text-gray-500 uppercase">Produk</th>
                                <th class="py-2 px-4 text-left text-xs font-medium text-gray-500 uppercase">Kategori</th>
                                <th class="py-2 px-4 text-center text-xs font-medium text-gray-500 uppercase">Jenis</th>
                                <th class="py-2 px-4 text-center text-xs font-medium text-gray-500 uppercase">Jumlah</th>
                                <th class="py-2 px-4 text-center text-xs font-medium text-gray-500 uppercase">Stok Akhir</th>
                                <th class="py-2 px-4 text-center text-xs font-medium text-gray-500 uppercase">Status</th>
                                <th class="py-2 px-4 text-left text-xs font-medium text-gray-500 uppercase">Sumber</th>
                                <th class="py-2 px-4 text-left text-xs font-medium text-gray-500 uppercase">Oleh</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-200">
                            ${stockWithStatus.map(entry => `
                                <tr>
                                    <td class="py-3 px-4 whitespace-nowrap text-sm">${new Date(entry.timestamp).toLocaleString('id-ID')}</td>
                                    <td class="py-3 px-4 whitespace-nowrap text-sm font-medium text-gray-900">${entry.productName}</td>
                                    <td class="py-3 px-4 whitespace-nowrap text-sm">${formatDepartment(entry.category)}</td>
                                    <td class="py-3 px-4 whitespace-nowrap text-center text-sm ${entry.type.includes('Masuk') ? 'text-green-600' : 'text-red-600'}">${entry.type}</td>
                                    <td class="py-3 px-4 whitespace-nowrap text-center text-sm">${entry.quantity}</td>
                                    <td class="py-3 px-4 whitespace-nowrap text-center text-sm">${entry.finalStock}</td>
                                    <td class="py-3 px-4 whitespace-nowrap text-center">
                                        <span class="px-2 py-1 text-xs font-medium rounded-full ${entry.statusClass}">${entry.status}</span>
                                    </td>
                                    <td class="py-3 px-4 whitespace-nowrap text-xs text-gray-500">${entry.source}</td>
                                    <td class="py-3 px-4 whitespace-nowrap text-xs text-gray-500">${getUsernameById(entry.userId)}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
                <div class="mt-8 p-6 bg-white rounded-2xl shadow-sm border border-gray-200">
                    <h4 class="text-lg font-semibold text-gray-800 mb-4">TTD Penanggung Jawab</h4>
                    <div class="grid grid-cols-3 gap-8">
                        <div class="text-center">
                            <p class="border-b border-black py-16"></p>
                            <p class="mt-2 font-medium">Admin Gudang</p>
                        </div>
                        <div class="text-center">
                            <p class="border-b border-black py-16"></p>
                            <p class="mt-2 font-medium">Manager Produksi</p>
                        </div>
                        <div class="text-center">
                            <p class="border-b border-black py-16"></p>
                            <p class="mt-2 font-medium">Direktur</p>
                        </div>
                    </div>
                </div>
            `;
        }

        /**
         * Merender daftar permintaan produksi untuk gudang dan produksi.
         * @param {string} context - Konteks pemanggilan ('production-tab', 'warehouse-tab', 'report-view').
         * @returns {string} String HTML untuk permintaan produksi.
         */
        function renderProductionRequests(context) {
            const { userRole, userDepartment } = appState;
            const isAdmin = userRole === 'admin' || userRole === 'super_admin';

            let requests = appState.warehouse.productionRequests.filter(request => {
                if (isAdmin) return true;

                if (context === 'production-tab' && userDepartment === 'produksi') {
                    return request.status === 'pending' || request.status === 'approved_by_production' || request.status === 'completed_production';
                }
                if (context === 'warehouse-tab' && userDepartment === 'gudang') {
                    return request.requestedBy === appState.userId || request.status === 'completed_production' || request.status === 'approved_by_warehouse';
                }
                if (context === 'report-view') {
                    return request.requestedBy === appState.userId;
                }
                return false;
            }).sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

            let titleText = 'Daftar Permintaan Produksi';
            if (context === 'production-tab') {
                titleText = 'Permintaan Gudang (Untuk Produksi)';
            } else if (context === 'warehouse-tab') {
                titleText = 'Produk Masuk (Menunggu Penerimaan Gudang)';
            } else if (context === 'report-view') {
                titleText = 'Laporan Permintaan Produksi Saya';
            }

            // Filter berdasarkan kategori jika ada di warehouse context
            if (context === 'warehouse-tab' && appState.warehouse.selectedCategoryFilter && appState.warehouse.selectedCategoryFilter !== 'all') {
                requests = requests.filter(request => {
                    const product = appState.warehouse.inventory.find(item => item.id === request.productId);
                    return product && product.category === appState.warehouse.selectedCategoryFilter;
                });
            }

            const garmentCategories = Object.values(GARMENT_PATTERNS).map(p => ({ id: p.title.toLowerCase(), name: p.title }));

            const getStatusBadge = (status) => {
                switch (status) {
                    case 'pending':
                        return '<span class="px-2 py-1 text-xs font-medium rounded-full bg-yellow-100 text-yellow-800">Menunggu Persetujuan Produksi</span>';
                    case 'approved_by_production':
                        return '<span class="px-2 py-1 text-xs font-medium rounded-full bg-blue-100 text-blue-800">Disetujui Produksi (Dalam Proses)</span>';
                    case 'completed_production':
                        return '<span class="px-2 py-1 text-xs font-medium rounded-full bg-purple-100 text-purple-800">Produksi Selesai (Menunggu Gudang)</span>';
                    case 'approved_by_warehouse':
                        return '<span class="px-2 py-1 text-xs font-medium rounded-full bg-green-100 text-green-800">Selesai (Stok Diterima Gudang)</span>';
                    case 'rejected':
                        return '<span class="px-2 py-1 text-xs font-medium rounded-full bg-red-100 text-red-800">Ditolak</span>';
                    default:
                        return '<span class="px-2 py-1 text-xs font-medium rounded-full bg-gray-100 text-gray-800">' + status + '</span>';
                }
            };

            return `
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-gray-800">${titleText}</h3>
                    <div class="flex gap-2">
                        ${context === 'warehouse-tab' ? `
                            <select id="productionRequestCategoryFilter" class="p-2 border rounded-md text-sm">
                                <option value="all">Semua Kategori</option>
                                ${garmentCategories.map(cat => `<option value="${cat.id}" ${appState.warehouse.selectedCategoryFilter === cat.id ? 'selected' : ''}>${cat.name}</option>`).join('')}
                            </select>
                        ` : ''}
                        <button id="refreshProductionRequestsBtn" class="flex items-center gap-1 text-sm text-indigo-600 hover:text-indigo-800">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 2v6h-6"></path><path d="M3 12a9 9 0 0 1 15-6.7L21 8"></path><path d="M3 22v-6h6"></path><path d="M21 12a9 9 0 0 1-15 6.7L3 16"></path></svg>
                            Refresh
                        </button>
                    </div>
                </div>

                ${requests.length === 0 ? `
                    <div class="p-6 bg-white rounded-2xl text-center text-gray-500">
                        <p>Tidak ada permintaan yang perlu ditindaklanjuti atau ditampilkan.</p>
                        ${userDepartment === 'gudang' && context === 'warehouse-tab' ? `<p class="mt-2">Gunakan tombol "Minta Produksi" di tab Inventaris untuk membuat permintaan baru.</p>` : ''}
                    </div>
                ` : `
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tanggal</th>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Produk</th>
                                    <th scope="col" class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Jumlah</th>
                                    <th scope="col" class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                    <th scope="col" class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Diminta Oleh</th>
                                    <th scope="col" class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                ${requests.map(request => `
                                    <tr class="hover:bg-gray-50">
                                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">${new Date(request.timestamp).toLocaleString('id-ID', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' })}</td>
                                        <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-900">${request.productName}</td>
                                        <td class="px-4 py-3 whitespace-nowrap text-sm text-center">${request.requestedQuantity} pcs</td>
                                        <td class="px-4 py-3 whitespace-nowrap text-sm text-center">${getStatusBadge(request.status)}</td>
                                        <td class="px-4 py-3 whitespace-nowrap text-sm text-center text-gray-500">${getUsernameById(request.requestedBy)}</td>
                                        <td class="px-4 py-3 whitespace-nowrap text-right text-sm font-medium">
                                            <div class="flex justify-end gap-2">
                                                <button class="view-request-notes-btn text-indigo-600 hover:text-indigo-900" data-id="${request.id}" title="Lihat Catatan">
                                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-file-text"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><line x1="10" y1="9" x2="8" y2="9"/></svg>
                                                </button>

                                                ${(userDepartment === 'produksi' || isAdmin) && request.status === 'pending' ? `
                                                    <button class="update-request-status-btn py-1 px-3 bg-green-100 text-green-700 rounded-md text-sm hover:bg-green-200" data-id="${request.id}" data-status="approved_by_production" title="Setujui Produksi">
                                                        Setujui Produksi
                                                    </button>
                                                    <button class="update-request-status-btn py-1 px-3 bg-red-100 text-red-700 rounded-md text-sm hover:bg-red-200" data-id="${request.id}" data-status="rejected" title="Tolak">
                                                        Tolak
                                                    </button>
                                                ` : ''}

                                                ${(userDepartment === 'produksi' || isAdmin) && request.status === 'approved_by_production' ? `
                                                    <button class="update-request-status-btn py-1 px-3 bg-blue-100 text-blue-700 rounded-md text-sm hover:bg-blue-200" data-id="${request.id}" data-status="completed_production" title="Selesai Produksi">
                                                        Barang Sudah Siap
                                                    </button>
                                                ` : ''}

                                                ${(userDepartment === 'gudang' || isAdmin) && request.status === 'completed_production' ? `
                                                    <button class="update-request-status-btn py-1 px-3 bg-purple-100 text-purple-700 rounded-md text-sm hover:bg-purple-200" data-id="${request.id}" data-status="approved_by_warehouse" title="Terima Barang">
                                                        Terima Barang
                                                    </button>
                                                ` : ''}

                                                ${(isAdmin || (userDepartment === 'gudang' && request.requestedBy === appState.userId && (request.status === 'pending' || request.status === 'rejected')) || (userDepartment === 'produksi' && request.status === 'rejected')) ? `
                                                    <button class="delete-request-btn text-red-600 hover:text-red-900" data-id="${request.id}" title="Hapus">
                                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                                                    </button>
                                                ` : ''}
                                            </div>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `}
            `;
        }

        /**
         * Merender konten untuk tab Manajemen Akun.
         * @returns {string} String HTML untuk konten manajemen akun.
         */
        function renderAccountManagementContent() {
            if (appState.userRole !== 'admin' && appState.userRole !== 'super_admin') {
                return `<div class="p-6 bg-white rounded-2xl text-center text-red-500">Anda tidak memiliki izin untuk mengakses halaman ini.</div>`;
            }
            const pendingUsersHtml = appState.pendingUsers.length > 0 ? `<h3 class="text-xl font-bold text-gray-800 mb-4">Akun Menunggu Persetujuan (${appState.pendingUsers.length})</h3><div class="space-y-4">${appState.pendingUsers.map(user => `<div class="p-4 bg-yellow-50 rounded-xl shadow-sm border flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4"><div class="flex-1"><p class="font-semibold text-gray-800">${user.username}</p><p class="text-sm text-gray-600">Departemen: <span class="font-medium">${formatDepartment(user.department)}</span></p><p class="text-xs text-gray-400 mt-1">Terdaftar: ${new Date(user.createdAt).toLocaleString('id-ID')}</p></div><div class="flex items-center gap-2 self-end sm:self-center"><button class="approve-user-btn py-1 px-3 bg-green-100 text-green-600 rounded-md text-sm font-medium hover:bg-green-200" data-uid="${user.uid}">Setujui</button><button class="reject-user-btn py-1 px-3 bg-red-100 text-red-600 rounded-md text-sm font-medium hover:bg-red-200" data-uid="${user.uid}">Tolak</button></div></div>`).join('')}</div>` : `<div class="p-6 bg-white rounded-2xl text-center text-gray-500"><p>Tidak ada akun yang menunggu persetujuan.</p></div>`;
            const allUsersHtml = `<h3 class="text-xl font-bold text-gray-800 mb-4 mt-8 border-t pt-4">Semua Akun Pengguna (${appState.allUsers.length})</h3><div class="space-y-4">${appState.allUsers.map(user => {
                let departmentDropdown = '';
                let roleDisplay = formatRole(user.role);
                if (appState.userRole === 'super_admin' && user.role !== 'super_admin') {
                    departmentDropdown = `<select class="change-department-select py-1 px-2 border rounded-md text-sm" data-uid="${user.uid}"><option value="produksi" ${user.department === 'produksi' ? 'selected' : ''}>Produksi</option><option value="gudang" ${user.department === 'gudang' ? 'selected' : ''}>Gudang</option><option value="penjualan" ${user.department === 'penjualan' ? 'selected' : ''}>Penjualan</option></select>`;
                    roleDisplay = `<select class="change-role-select py-1 px-2 border rounded-md text-sm ml-2" data-uid="${user.uid}"><option value="member" ${user.role === 'member' ? 'selected' : ''}>Anggota</option><option value="admin" ${user.role === 'admin' ? 'selected' : ''}>Wakil CEO</option></select>`;
                } else if (appState.userRole === 'admin' && user.role === 'member') {
                    departmentDropdown = `<select class="change-department-select py-1 px-2 border rounded-md text-sm" data-uid="${user.uid}"><option value="produksi" ${user.department === 'produksi' ? 'selected' : ''}>Produksi</option><option value="gudang" ${user.department === 'gudang' ? 'selected' : ''}>Gudang</option><option value="penjualan" ${user.department === 'penjualan' ? 'selected' : ''}>Penjualan</option></select>`;
                } else {
                    departmentDropdown = `<span class="text-sm text-gray-500">${formatDepartment(user.department) || ''}</span>`;
                }
                let deleteButton = '';
                if (appState.userRole === 'super_admin' && user.uid !== appState.userId) {
                    deleteButton = `<button class="delete-user-btn text-red-500 hover:text-red-700" title="Hapus pengguna" data-uid="${user.uid}"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trash-2"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg></button>`;
                }
                return `<div class="p-4 bg-gray-50 rounded-xl shadow-sm border flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4"><div class="flex-1"><p class="font-semibold text-gray-800">${user.username}</p><p class="text-sm text-gray-600">Peran: <span class="font-medium">${roleDisplay}</span> ${user.department ? `| Departemen: ${departmentDropdown}` : ''}</p><p class="text-xs text-gray-400">UID: ${user.uid}</p></div><div class="flex items-center gap-2 self-end sm:self-center">${deleteButton}</div></div>`;
            }).join('')}</div>`;
            return `<div class="p-6 bg-white rounded-2xl shadow-sm border"><h2 class="text-2xl font-bold text-gray-800 mb-6">Manajemen Akun Pengguna</h2>${pendingUsersHtml}${allUsersHtml}</div>`;
        }

        /**
         * Merender konten untuk tab Laporan.
         * @returns {string} String HTML untuk konten laporan.
         */
        function renderReportContent() {
            const { userRole, userDepartment } = appState;
            const isAdmin = userRole === 'admin' || userRole === 'super_admin';

            const visibleSubTabs = {
                production: isAdmin || userDepartment === 'produksi',
                sales: isAdmin || userDepartment === 'penjualan',
                finance: isAdmin,
                product: isAdmin,
            };

            return `
                <div class="p-6 bg-gray-50 rounded-2xl">
                    <div class="flex flex-wrap space-x-2 border-b border-gray-300 mb-6">
                        ${visibleSubTabs.production ? `<button id="reportsListTabBtn" class="py-2 px-4 text-sm font-semibold ${appState.activeReportTab === 'reports-list' ? 'border-b-2 border-indigo-600 text-indigo-600' : 'text-gray-500 hover:text-indigo-600'}">Laporan Produksi</button>` : ''}
                        ${visibleSubTabs.sales ? `<button id="salesReportTabBtn" class="py-2 px-4 text-sm font-semibold ${appState.activeReportTab === 'sales-report' ? 'border-b-2 border-indigo-600 text-indigo-600' : 'text-gray-500 hover:text-indigo-600'}">Laporan Penjualan</button>` : ''}
                        ${visibleSubTabs.finance ? `<button id="financialRecapTabBtn" class="py-2 px-4 text-sm font-semibold ${appState.activeReportTab === 'financial-recap' ? 'border-b-2 border-indigo-600 text-indigo-600' : 'text-gray-500 hover:text-indigo-600'}">Rekap Keuangan</button>` : ''}
                        ${visibleSubTabs.product ? `<button id="productVisTabBtn" class="py-2 px-4 text-sm font-semibold ${appState.activeReportTab === 'product-vis' ? 'border-b-2 border-indigo-600 text-indigo-600' : 'text-gray-500 hover:text-indigo-600'}">Rekap Produk</button>` : ''}
                    </div>
                    <div class="p-4 bg-white rounded-xl shadow-sm border border-gray-200 mb-6">
                        <h4 class="text-lg font-semibold text-gray-700 flex items-center gap-2 mb-3"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-calendar-days"><path d="M8 2v4"/><path d="M16 2v4"/><rect width="18" height="18" x="3" y="4" rx="2"/><path d="M3 10h18"/><path d="M8 14h.01"/><path d="M12 14h.01"/><path d="M16 14h.01"/><path d="M8 18h.01"/><path d="M12 18h.01"/><path d="M16 18h.01"/></svg>Filter Berdasarkan Tanggal</h4>
                        <div class="flex flex-col sm:flex-row items-center gap-4">
                            <input type="date" id="startDate" value="${appState.startDate}" class="w-full sm:w-1/2 p-2 border border-gray-300 rounded-md shadow-sm text-sm"/>
                            <span class="text-gray-500">sampai</span>
                            <input type="date" id="endDate" value="${appState.endDate}" class="w-full sm:w-1/2 p-2 border border-gray-300 rounded-md shadow-sm text-sm"/>
                        </div>
                        <div class="flex flex-col sm:flex-row gap-2 mt-4">
                            <button id="resetFilterBtn" class="flex-1 py-2 px-4 bg-gray-50 text-gray-700 rounded-md text-sm font-medium hover:bg-gray-100">Reset Filter</button>
                        </div>
                    </div>
                    <div id="reportContentContainer"></div>
                </div>
            `;
        }

        /**
         * Merender sub-konten yang sesuai untuk tab Laporan berdasarkan `appState.activeReportTab`.
         */
        function renderReportSubContent() {
            const reportContentContainer = document.getElementById('reportContentContainer');
            if (!reportContentContainer) return;

            if (appState.selectedReport) {
                renderSingleReportDetail();
            } else if (appState.selectedSale) {
                renderSingleSaleDetail();
            } else if (appState.activeReportTab === 'reports-list') {
                renderMaterialReportList();
            } else if (appState.activeReportTab === 'sales-report') {
                renderSalesReportList();
            } else if (appState.activeReportTab === 'financial-recap') {
                renderFinancialReport();
            } else if (appState.activeReportTab === 'product-vis') {
                renderProductVisualizationChart();
            }
        }

        /**
         * Merender daftar laporan produksi (HPP).
         * @returns {string} String HTML untuk daftar laporan bahan.
         */
        function renderMaterialReportList() {
            const container = document.getElementById('reportContentContainer');
            if (!container) return;
            const displayReports = appState.filteredReports.filter(report => !report.isSuperseded);
            if (displayReports.length === 0) {
                container.innerHTML = `<div class="p-6 bg-white rounded-2xl text-center text-gray-500"><p>Tidak ada laporan produksi yang cocok dengan filter saat ini.</p></div>`;
                return;
            }
            container.innerHTML = `
                <div class="p-6 bg-white rounded-2xl shadow-sm border border-gray-200">
                    <h3 class="text-2xl font-bold text-gray-800 mb-4">Daftar Laporan Produksi (HPP)</h3>
                    <div class="space-y-4" id="reportsList">
                        ${displayReports.map(report => {
                            const canDelete = appState.userRole === 'super_admin' || appState.userRole === 'admin' ||
                                (appState.userRole === 'member' && report.userId === appState.userId);
                            return `
                                <div class="p-4 bg-gray-50 rounded-xl shadow-sm border flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                                    <div class="flex-1">
                                        <p class="font-semibold text-gray-800">Laporan ${GARMENT_PATTERNS[report.selectedGarment].title} (${report.hppResult.garmentsProduced} pcs) ${report.isRevised ? '<span class="text-xs text-blue-500 font-medium ml-2">(Revisi)</span>' : ''}</p>
                                        <p class="text-sm text-gray-600">HPP Rata-rata: <span class="font-medium">Rp ${formatRupiah(report.hppResult.totalHPP)}</span></p>
                                        ${(appState.userRole === 'admin' || appState.userRole === 'super_admin') ? `<p class="text-xs text-gray-400 mt-1">Dibuat oleh: <span class="font-medium">${getUsernameById(report.userId)}</span> pada ${new Date(report.timestamp).toLocaleString('id-ID')}</p>` : `<p class="text-xs text-gray-400 mt-1">Dibuat pada ${new Date(report.timestamp).toLocaleString('id-ID')}</p>`}
                                        ${report.productionRequestId ? `<p class="text-xs text-gray-400 mt-1">Terkait Permintaan Produksi: #${report.productionRequestId.substring(0, 8).toUpperCase()}</p>` : ''}
                                    </div>
                                    <div class="flex items-center gap-2 self-end sm:self-center">
                                        <button class="view-detail-btn py-1 px-3 bg-indigo-100 text-indigo-600 rounded-md text-sm font-medium hover:bg-indigo-200" data-id="${report.id}">Lihat Detail</button>
                                        ${canDelete ? `
                                            <button class="remove-report-btn text-red-500 hover:text-red-700" title="Hapus laporan" data-id="${report.id}">
                                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trash-2"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>
                                            </button>
                                        ` : ''}
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
        }

        /**
         * Merender daftar laporan penjualan.
         * @returns {string} String HTML untuk daftar laporan penjualan.
         */
        function renderSalesReportList() {
            const container = document.getElementById('reportContentContainer');
            if (!container) return;

            const displaySales = appState.filteredSales;

            if (displaySales.length === 0) {
                container.innerHTML = `<div class="p-6 bg-white rounded-2xl text-center text-gray-500"><p>Tidak ada laporan penjualan yang cocok dengan filter saat ini.</p></div>`;
                return;
            }

            container.innerHTML = `
                <div class="p-6 bg-white rounded-2xl shadow-sm border border-gray-200">
                    <h3 class="text-2xl font-bold text-gray-800 mb-4">Daftar Laporan Penjualan</h3>
                    <div class="space-y-4" id="salesReportsList">
                        ${displaySales.map(sale => `
                            <div class="p-4 bg-gray-50 rounded-xl shadow-sm border flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                                <div class="flex-1">
                                    <p class="font-semibold text-gray-800">Struk No: ${sale.id}</p>
                                    <p class="text-sm text-gray-600">Pelanggan: <span class="font-medium">${sale.customerName || 'Umum'}</span></p>
                                    <p class="text-sm text-gray-600">Total Penjualan: <span class="font-medium text-green-700">Rp ${formatRupiah(sale.result.grandTotal)}</span></p>
                                    <p class="text-xs text-gray-400 mt-1">Dibuat oleh: <span class="font-medium">${getUsernameById(sale.userId)}</span> pada ${new Date(sale.timestamp).toLocaleString('id-ID')}</p>
                                </div>
                                <div class="flex items-center gap-2 self-end sm:self-center">
                                    <button class="view-sale-detail-btn py-1 px-3 bg-green-100 text-green-600 rounded-md text-sm font-medium hover:bg-green-200" data-id="${sale.id}">Lihat Detail</button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        /**
         * Merender tampilan detail laporan produksi tunggal.
         */
        function renderSingleReportDetail() {
            const container = document.getElementById('reportContentContainer');
            if (!container) return;

            const { hppResult, otherCosts, selectedGarment: reportGarment, timestamp, isRevised, revisionNotes, userId, productionRequestId, isWarehouseApproved } = appState.selectedReport;
            const date = new Date(timestamp).toLocaleString('id-ID');
            const isMemberOrUser = (appState.userRole === 'member' || appState.userRole === 'user');
            const isOwnReport = (userId === appState.userId);
            const timeDiffHours = (new Date() - new Date(timestamp)) / (1000 * 60 * 60);
            const isWithin24Hours = timeDiffHours <= 24;
            const canRevise = isMemberOrUser && isOwnReport && !isRevised && isWithin24Hours && !isWarehouseApproved;

            container.innerHTML = `
                <div class="p-6 bg-white rounded-2xl shadow-sm border">
                    <button id="backToReportListBtn" class="text-indigo-600 hover:text-indigo-800 font-semibold mb-4 flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-arrow-left"><path d="m12 19-7-7 7-7"/><path d="M19 12H5"/></svg>
                        Kembali ke Daftar
                    </button>
                    <h3 class="text-2xl font-bold text-gray-800">Laporan HPP - ${GARMENT_PATTERNS[reportGarment].title}</h3>
                    <p class="text-sm text-gray-500 mb-6">Dibuat pada: ${date}</p>
                    ${isRevised ? `
                        <div class="p-3 bg-blue-100 text-blue-800 rounded-md mb-4 flex items-start gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-info"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></svg>
                            <div>
                                <p class="font-semibold text-sm">Laporan ini adalah hasil revisi.</p>
                                ${revisionNotes ? `<p class="text-xs">Catatan Revisi: ${revisionNotes}</p>` : ''}
                            </div>
                        </div>` : ''}
                    ${isWarehouseApproved ? `
                        <div class="p-3 bg-green-100 text-green-800 rounded-md mb-4 flex items-start gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-check-circle"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><path d="m9 11 3 3L22 4"/></svg>
                            <p class="font-semibold text-sm">Stok dari laporan ini sudah diterima gudang.</p>
                        </div>` : ''}
                    ${productionRequestId ? `
                        <div class="p-3 bg-gray-100 text-gray-800 rounded-md mb-4 flex items-start gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-link"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07L9.4 9.4"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07L14.6 14.6"/></svg>
                            <p class="font-semibold text-sm">Terkait Permintaan Produksi: #${productionRequestId.substring(0, 8).toUpperCase()}</p>
                        </div>` : ''}
                    <h4 class="text-lg font-semibold text-gray-700 mt-4 pt-4 border-t">Rincian Pesanan</h4>
                    <div class="space-y-3 mt-4">
                        ${hppResult.garmentOrder.map(item => `
                            <div class="p-3 bg-gray-50 rounded-lg border">
                                <p class="font-bold text-gray-800">${GARMENT_PATTERNS[reportGarment].title} ${item.model ? `(${item.model})` : ''} - Ukuran ${item.size} ${item.color ? `(${item.color})` : ''}</p>
                                <p class="text-sm text-gray-600">Jumlah: <span class="font-medium">${item.quantity} pcs</span></p>
                            </div>
                        `).join('')}
                    </div>
                    ${canRevise ? `
                        <button id="reviseReportBtn" class="w-full mt-6 bg-blue-600 text-white font-bold py-3 px-4 rounded-xl shadow-md hover:bg-blue-700 transition-colors flex items-center justify-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-edit-3"><path d="M12 20h9"/><path d="M16.5 3.5a2.12 2.12 0 0 1 3 3L7 19l-4 1 1-4Z"/><path d="m15 5-3 3"/></svg>
                            Revisi Laporan
                        </button>` : ''}
                    <button id="printInvoiceBtn" class="w-full mt-4 bg-purple-600 text-white font-bold py-3 px-4 rounded-xl shadow-md hover:bg-purple-700 transition-colors flex items-center justify-center gap-2" data-type="production">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-printer"><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect width="12" height="8" x="6" y="14"/></svg>
                        Cetak Nota Produksi
                    </button>
                </div>
            `;
        }

        /**
         * Merender tampilan detail laporan penjualan tunggal.
         */
        function renderSingleSaleDetail() {
            const container = document.getElementById('reportContentContainer');
            if (!container || !appState.selectedSale) return;

            const sale = appState.selectedSale;
            const date = new Date(sale.timestamp).toLocaleString('id-ID');
            const result = sale.result;

            container.innerHTML = `
                <div class="p-6 bg-white rounded-2xl shadow-sm border">
                    <button id="backToReportListBtn" class="text-green-600 hover:text-green-800 font-semibold mb-4 flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-arrow-left"><path d="m12 19-7-7 7-7"/><path d="M19 12H5"/></svg>
                        Kembali ke Daftar
                    </button>
                    <h3 class="text-2xl font-bold text-gray-800">Detail Penjualan - Struk #${sale.id}</h3>
                    <p class="text-sm text-gray-500 mb-2">Tanggal: ${date}</p>
                    <p class="text-sm text-gray-500 mb-6">Pelanggan: ${sale.customerName || 'Umum'}</p>

                    <h4 class="text-lg font-semibold text-gray-700 mt-4 pt-4 border-t">Item Terjual</h4>
                    <div class="space-y-3 mt-4">
                        ${sale.items.map(item => `
                            <div class="p-3 bg-gray-50 rounded-lg border flex justify-between">
                                <div>
                                    <p class="font-bold text-gray-800">${item.name}</p>
                                    <p class="text-sm text-gray-600">Jumlah: <span class="font-medium">${item.quantity} pcs</span></p>
                                </div>
                                <div class="text-right">
                                    <p class="text-sm text-gray-600">@ Rp ${formatRupiah(item.price)}</p>
                                    <p class="font-semibold">Rp ${formatRupiah(item.price * item.quantity)}</p>
                                </div>
                            </div>
                        `).join('')}
                    </div>

                    <h4 class="text-lg font-semibold text-gray-700 mt-6 pt-4 border-t">Ringkasan Pembayaran</h4>
                    <div class="mt-4 space-y-2">
                        <div class="flex justify-between"><span class="text-gray-600">Subtotal</span><span>Rp ${formatRupiah(result.subtotal)}</p></div>
                        <div class="flex justify-between"><span class="text-gray-600">Diskon</span><span class="text-red-600">- Rp ${formatRupiah(result.discountAmount)}</p></div>
                        <div class="flex justify-between"><span class="text-gray-600">Pajak</span><p>Rp ${formatRupiah(result.taxAmount)}</p></div>
                    </div>
                    <div class="border-t-2 border-dashed border-gray-400 mt-2 pt-2 font-bold text-lg flex justify-between"><p>TOTAL</p><p>Rp ${formatRupiah(result.grandTotal)}</p></div>

                    <div class="text-center text-sm mt-6">** Terima Kasih **</div>
                    <button id="printInvoiceBtn" class="w-full mt-4 bg-purple-600 text-white font-bold py-3 px-4 rounded-xl shadow-md hover:bg-purple-700 transition-colors flex items-center justify-center gap-2" data-type="sale">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-printer"><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect width="12" height="8" x="6" y="14"/></svg>
                        Cetak Ulang Struk
                    </button>
                </div>
            `;
        }

        /**
         * Merender laporan keuangan (pendapatan, HPP, keuntungan).
         */
        function renderFinancialReport() {
            const container = document.getElementById('reportContentContainer');
            if (!container) return;
            const displayReports = appState.filteredReports;
            if (displayReports.length === 0) {
                container.innerHTML = `<div class="p-6 bg-white rounded-2xl text-center text-gray-500"><p>Tidak ada data untuk ditampilkan.</p></div>`;
                return;
            }
            const totalRevenue = displayReports.reduce((sum, r) => sum + (r.hppResult.sellingPricePerGarment * r.hppResult.garmentsProduced), 0);
            const totalCOGS = displayReports.reduce((sum, r) => sum + (r.hppResult.totalHPP * r.hppResult.garmentsProduced), 0);
            const totalProfit = totalRevenue - totalCOGS;
            container.innerHTML = `
                <div class="p-6 bg-white rounded-2xl shadow-sm border">
                    <h3 class="text-2xl font-bold text-gray-800 mb-4">Rekap Laporan Keuangan</h3>
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-8">
                        <div class="bg-green-50 p-4 rounded-xl text-center">
                            <p class="text-sm text-gray-600">Total Pendapatan</p>
                            <p class="text-xl font-bold text-green-700">Rp ${formatRupiah(totalRevenue)}</p>
                        </div>
                        <div class="bg-indigo-50 p-4 rounded-xl text-center">
                            <p class="text-sm text-gray-600">Total HPP (COGS)</p>
                            <p class="text-xl font-bold text-indigo-700">Rp ${formatRupiah(totalCOGS)}</p>
                        </div>
                        <div class="p-4 rounded-xl text-center ${totalProfit >= 0 ? 'bg-green-100' : 'bg-red-100'}">
                            <p class="text-sm text-gray-600">Total Keuntungan</p>
                            <p class="text-xl font-bold ${totalProfit >= 0 ? 'text-green-700' : 'text-red-700'}">Rp ${formatRupiah(totalProfit)}</p>
                        </div>
                    </div>
                    <div style="height: 300px;"><canvas id="financialChart"></canvas></div>
                </div>`;
            const monthlyData = {};
            displayReports.forEach(report => {
                const monthYear = new Date(report.timestamp).toLocaleString('id-ID', { month: 'short', year: 'numeric' });
                if (!monthlyData[monthYear]) {
                    monthlyData[monthYear] = { Penjualan: 0, HPP: 0, Keuntungan: 0 };
                }
                const revenue = report.hppResult.sellingPricePerGarment * report.hppResult.garmentsProduced;
                const cogs = report.hppResult.totalHPP * report.hppResult.garmentsProduced;
                monthlyData[monthYear].Penjualan += revenue;
                monthlyData[monthYear].HPP += cogs;
                monthlyData[monthYear].Keuntungan += (revenue - cogs);
            });
            const chartLabels = Object.keys(monthlyData).sort((a, b) => {
                const [monthA, yearA] = a.split(' ');
                const [monthB, yearB] = b.split(' ');
                const monthOrder = ['Jan', 'Feb', 'Mar', 'Apr', 'Mei', 'Jun', 'Jul', 'Agu', 'Sep', 'Okt', 'Nov', 'Des'];
                if (parseInt(yearA) !== parseInt(yearB)) {
                    return parseInt(yearA) - parseInt(yearB);
                }
                return monthOrder.indexOf(monthA) - monthOrder.indexOf(monthB);
            });
            const chartData = {
                labels: chartLabels,
                datasets: [
                    { label: 'Pendapatan', data: chartLabels.map(l => monthlyData[l].Penjualan), backgroundColor: '#22c55e' },
                    { label: 'HPP', data: chartLabels.map(l => monthlyData[l].HPP), backgroundColor: '#f59e0b' },
                    { label: 'Keuntungan', data: chartLabels.map(l => monthlyData[l].Keuntungan), backgroundColor: '#3b82f6' },
                ]
            };
            renderChart('financialChart', 'bar', chartData, 'Visualisasi Keuangan Bulanan');
        }

        /**
         * Merender grafik visualisasi produk.
         */
        function renderProductVisualizationChart() {
            const container = document.getElementById('reportContentContainer');
            if (!container) return;
            const displayReports = appState.filteredReports;
            if (displayReports.length === 0) {
                container.innerHTML = `<div class="p-6 bg-white rounded-2xl text-center text-gray-500"><p>Tidak ada data untuk ditampilkan.</p></div>`;
                return;
            }
            container.innerHTML = `
                <div class="p-6 bg-white rounded-2xl shadow-sm border">
                    <h3 class="text-2xl font-bold text-gray-800 mb-4">Rekap Produk</h3>
                    <div style="height: 300px;"><canvas id="productChart"></canvas></div>
                </div>`;
            let timeUnitFormatter;
            if (displayReports.length > 0) {
                const sortedReports = [...displayReports].sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
                const firstDate = new Date(sortedReports[0].timestamp);
                const lastDate = new Date(sortedReports[sortedReports.length - 1].timestamp);
                const diffTime = Math.abs(lastDate - firstDate);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                timeUnitFormatter = (date) => date.toLocaleString('id-ID', { month: 'short', year: 'numeric' });
            } else {
                timeUnitFormatter = (date) => date.getFullYear().toString();
            }
            const productDataByTimeUnit = {};
            const garmentTitles = Object.values(GARMENT_PATTERNS).map(p => p.title);
            const garmentColors = { 'Kaos': '#3b82f6', 'Kemeja': '#22c55e', 'Jaket': '#f59e0b', 'Celana': '#a855f7' };
            displayReports.forEach(report => {
                const reportDate = new Date(report.timestamp);
                const timeUnit = timeUnitFormatter(reportDate);
                if (!productDataByTimeUnit[timeUnit]) {
                    productDataByTimeUnit[timeUnit] = {};
                    garmentTitles.forEach(title => { productDataByTimeUnit[timeUnit][title] = 0; });
                }
                const garmentTitle = GARMENT_PATTERNS[report.selectedGarment].title;
                productDataByTimeUnit[timeUnit][garmentTitle] += report.hppResult.garmentsProduced;
            });
            const chartLabels = Object.keys(productDataByTimeUnit).sort((a, b) => {
                if (timeUnitFormatter === ((date) => date.getFullYear().toString())) {
                    return parseInt(a) - parseInt(b);
                } else {
                    const [monthA, yearA] = a.split(' ');
                    const [monthB, yearB] = b.split(' ');
                    const monthOrder = ['Jan', 'Feb', 'Mar', 'Apr', 'Mei', 'Jun', 'Jul', 'Agu', 'Sep', 'Okt', 'Nov', 'Des'];
                    if (parseInt(yearA) !== parseInt(yearB)) { return parseInt(yearA) - parseInt(yearB); }
                    return monthOrder.indexOf(monthA) - monthOrder.indexOf(monthB);
                }
            });
            const datasets = garmentTitles.map(title => ({
                label: title,
                data: chartLabels.map(timeUnit => productDataByTimeUnit[timeUnit][title]),
                backgroundColor: garmentColors[title],
            }));
            const chartData = { labels: chartLabels, datasets: datasets };
            renderChart('productChart', 'bar', chartData, 'Jumlah Produksi per Jenis Pakaian');
        }

        /**
         * Merender konten untuk tab Log Aktivitas.
         * @returns {string} String HTML untuk konten log aktivitas.
         */
        function renderActivityLogsContent() {
            if (appState.userRole !== 'super_admin') {
                return `<div class="p-6 bg-white rounded-2xl text-center text-red-500">Anda tidak memiliki izin untuk mengakses halaman ini.</div>`;
            }

            const logs = appState.activityLogs;

            if (logs.length === 0) {
                return `
                    <div class="p-6 bg-white rounded-2xl shadow-sm border border-gray-200">
                        <h3 class="text-2xl font-bold text-gray-800 mb-4">Aktivitas Kerja</h3>
                        <div class="text-center text-gray-500">Tidak ada aktivitas yang tercatat.</div>
                    </div>
                `;
            }

            return `
                <div class="p-6 bg-white rounded-2xl shadow-sm border border-gray-200">
                    <h3 class="text-2xl font-bold text-gray-800 mb-4">Aktivitas Kerja</h3>
                    <div class="overflow-x-auto">
                        <table class="min-w-full bg-white">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="py-2 px-4 text-left text-xs font-medium text-gray-500 uppercase">Waktu</th>
                                    <th class="py-2 px-4 text-left text-xs font-medium text-gray-500 uppercase">Tipe</th>
                                    <th class="py-2 px-4 text-left text-xs font-medium text-gray-500 uppercase">Deskripsi</th>
                                    <th class="py-2 px-4 text-left text-xs font-medium text-gray-500 uppercase">Oleh</th>
                                    <th class="py-2 px-4 text-left text-xs font-medium text-gray-500 uppercase">ID Terkait</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-200">
                                ${logs.map(log => `
                                    <tr>
                                        <td class="py-3 px-4 whitespace-nowrap text-sm">${new Date(log.timestamp).toLocaleString('id-ID')}</td>
                                        <td class="py-3 px-4 whitespace-nowrap text-sm font-medium text-gray-900">${log.type}</td>
                                        <td class="py-3 px-4 text-sm text-gray-700">${log.description}</td>
                                        <td class="py-3 px-4 whitespace-nowrap text-xs text-gray-500">${getUsernameById(log.userId)}</td>
                                        <td class="py-3 px-4 whitespace-nowrap text-xs text-gray-500">${log.relatedId ? log.relatedId.substring(0, 8) + '...' : '-'}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        /**
         * Merender grafik menggunakan Chart.js.
         * @param {string} canvasId - ID elemen canvas.
         * @param {string} type - Tipe grafik (misal: 'bar', 'line', 'pie').
         * @param {object} data - Objek data untuk grafik.
         * @param {string} title - Judul grafik.
         */
        function renderChart(canvasId, type, data, title) {
            const ctx = document.getElementById(canvasId);
            if (!ctx) {
                console.error(`Canvas element with ID '${canvasId}' not found.`);
                return;
            }

            if (currentChart) {
                currentChart.destroy();
            }

            currentChart = new Chart(ctx, {
                type: type,
                data: data,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: title,
                            font: {
                                size: 16,
                                weight: 'bold'
                            },
                            color: '#374151'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.y !== null) {
                                        if (canvasId === 'financialChart') {
                                            label += `Rp ${formatRupiah(context.parsed.y)}`;
                                        } else {
                                            label += `${formatRupiah(context.parsed.y)} pcs`;
                                        }
                                    }
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    if (canvasId === 'financialChart') {
                                        return `Rp ${formatRupiah(value)}`;
                                    }
                                    return `${formatRupiah(value)} pcs`;
                                }
                            }
                        }
                    }
                }
            });
        }

        /**
         * Menghasilkan dan menampilkan HTML untuk faktur produksi.
         * @param {object} report - Data laporan produksi.
         * @returns {string} String HTML untuk faktur produksi.
         */
        function generateProductionInvoiceHTML(report) {
            const { hppResult, otherCosts, selectedGarment, timestamp } = report;
            const invoiceNumber = `PROD-${report.id.substring(0, 8).toUpperCase()}`;
            const totalAdditionalItemsCost = (otherCosts && Array.isArray(otherCosts.additionalItems)) ? otherCosts.additionalItems.reduce((sum, item) => sum + (item.cost * item.quantity), 0) : 0;
            const totalPayment = hppResult.sellingPricePerGarment * hppResult.garmentsProduced;

            return `
                <div class="font-sans text-gray-800">
                    <div class="flex justify-between items-center mb-8 pb-4 border-b-2 border-gray-300">
                        <div class="text-2xl font-bold text-indigo-700">NOTA PRODUKSI</div>
                        <img src="${logoUrl}" alt="Logo" class="h-16 w-auto object-contain">
                    </div>
                    <div class="grid grid-cols-2 gap-4 mb-8 text-sm">
                        <div><p class="font-semibold text-gray-700">Dari:</p><p class="font-bold text-lg">KAZUMI</p><p>Bandung, Indonesia</p></div>
                        <div class="text-right"><p class="font-semibold text-gray-700">Nota No: <span class="font-normal">${invoiceNumber}</span></p><p class="font-semibold text-gray-700">Tanggal: <span class="font-normal">${new Date(timestamp).toLocaleDateString('id-ID')}</span></p></div>
                    </div>
                    <table class="min-w-full bg-white border border-gray-200">
                        <thead class="bg-gray-100"><tr><th class="py-2 px-4 text-left text-xs font-medium text-gray-600 uppercase">Deskripsi</th><th class="py-2 px-4 text-center text-xs font-medium text-gray-600 uppercase">Jumlah</th><th class="py-2 px-4 text-right text-xs font-medium text-gray-600 uppercase">Harga Satuan</th><th class="py-2 px-4 text-right text-xs font-medium text-gray-600 uppercase">Total</th></tr></thead>
                        <tbody>${hppResult.garmentOrder.map(item => `<tr><td class="py-2 px-4 border-b text-sm">${GARMENT_PATTERNS[selectedGarment].title} ${item.model ? `(${item.model})` : ''} - ${item.size} ${item.color ? `(${item.color})` : ''}</td><td class="py-2 px-4 border-b text-sm text-center">${item.quantity}</td><td class="py-2 px-4 border-b text-sm text-right">Rp ${formatRupiah(hppResult.sellingPricePerGarment)}</td><td class="py-2 px-4 border-b text-sm text-right">Rp ${formatRupiah(hppResult.sellingPricePerGarment * item.quantity)}</td></tr>`).join('')}</tbody>
                    </table>
                    <div class="flex justify-end mt-4"><div class="w-full sm:w-1/2 space-y-2 text-right"><div class="flex justify-between font-semibold"><span>Total HPP:</span><span>Rp ${formatRupiah(hppResult.totalHPP * hppResult.garmentsProduced)}</span></div><div class="flex justify-between font-semibold"><span>Biaya Tambahan:</span><span>Rp ${formatRupiah(totalAdditionalItemsCost)}</span></div><div class="flex justify-between font-bold text-lg border-t pt-2 mt-2"><span>TOTAL NILAI PRODUKSI:</span><span>Rp ${formatRupiah(totalPayment)}</span></div></div></div>
                    <div class="text-center text-sm text-gray-600 mt-12 pt-4 border-t">Terima kasih.</div>
                </div>`;
        }

        /**
         * Menghasilkan dan menampilkan HTML untuk faktur penjualan.
         * @param {object} sale - Data penjualan.
         * @returns {string} String HTML untuk faktur penjualan.
         */
        function generateSaleInvoiceHTML(sale) {
            const { id, customerName, items, result, timestamp } = sale;
            return `
                <div class="font-sans text-gray-800">
                    <div class="text-center mb-6"><h2 class="text-2xl font-bold">KAZUMI</h2><p class="text-sm">Bandung, Indonesia</p></div>
                    <div class="text-sm mb-4"><p>No: ${id}</p><p>Tgl: ${new Date(timestamp).toLocaleString('id-ID')}</p><p>Kasir: ${getUsernameById(sale.userId)}</p><p>Pelanggan: ${customerName || 'Umum'}</p></div>
                    <div class="border-t-2 border-dashed border-gray-400 pt-2">
                        ${items.map(item => `<div class="flex justify-between text-sm"><p>${item.quantity}x ${item.name}</p><p>Rp ${formatRupiah(item.price * item.quantity)}</p></div>`).join('')}
                    </div>
                    <div class="border-t border-dashed border-gray-400 mt-2 pt-2 text-sm">
                        <div class="flex justify-between"><p>Subtotal</p><p>Rp ${formatRupiah(result.subtotal)}</p></div>
                        <div class="flex justify-between"><p>Diskon</p><p class="text-red-600">- Rp ${formatRupiah(result.discountAmount)}</p></div>
                        <div class="flex justify-between"><p>Pajak</p><p>Rp ${formatRupiah(result.taxAmount)}</p></div>
                    </div>
                    <div class="border-t-2 border-dashed border-gray-400 mt-2 pt-2 font-bold text-lg flex justify-between"><p>TOTAL</p><p>Rp ${formatRupiah(result.grandTotal)}</p></div>

                    <div class="text-center text-sm mt-6">** Terima Kasih **</div>
                </div>`;
        }

        /**
         * Menampilkan pratinjau cetak dan menangani pencetakan.
         * @param {'production'|'sale'} type - Tipe faktur yang akan dicetak.
         */
        function printInvoice(type) {
            const printArea = document.getElementById('print-area');
            if (!printArea) return;

            let contentToPrint = '';
            let relatedId = null;
            let description = '';

            if (type === 'production' && appState.selectedReport) {
                contentToPrint = generateProductionInvoiceHTML(appState.selectedReport);
                relatedId = appState.selectedReport.id;
                description = `Mencetak nota produksi untuk laporan HPP #${relatedId.substring(0, 8).toUpperCase()}.`;
            } else if (type === 'sale' && appState.selectedSale) {
                contentToPrint = generateSaleInvoiceHTML(appState.selectedSale);
                relatedId = appState.selectedSale.id;
                description = `Mencetak ulang struk penjualan #${relatedId.substring(0, 8).toUpperCase()}.`;
            } else {
                showCustomMessage('Tidak ada data untuk dicetak.', 'error');
                return;
            }

            const printWrapper = document.createElement('div');
            printWrapper.className = "bg-white p-8 max-w-2xl mx-auto my-8 rounded-lg shadow-lg";
            printWrapper.innerHTML = contentToPrint;

            const buttonContainer = document.createElement('div');
            buttonContainer.className = "absolute top-4 right-4 flex gap-2";

            const closeButton = document.createElement('button');
            closeButton.innerText = 'Tutup Pratinjau';
            closeButton.className = "py-2 px-4 bg-red-500 text-white rounded-md hover:bg-red-600";
            closeButton.onclick = () => {
                printArea.style.display = 'none';
                printArea.innerHTML = '';
            };

            const printButton = document.createElement('button');
            printButton.innerText = 'Cetak';
            printButton.className = "py-2 px-4 bg-blue-500 text-white rounded-md hover:bg-blue-600";
            printButton.onclick = () => {
                window.print();
                addActivityLog('Cetak', description, appState.userId, relatedId);
            };

            printArea.innerHTML = '';
            printArea.appendChild(printWrapper);
            printArea.appendChild(buttonContainer);
            buttonContainer.appendChild(printButton);
            buttonContainer.appendChild(closeButton);
            printArea.style.display = 'block';
        }

        // =====================================================================================================
        // BAGIAN 6: EVENT HANDLERS (Logika Bisnis & Modifikasi State)
        // =====================================================================================================

        /**
         * Menangani login pengguna.
         */
        function handleLogin() {
            const usernameInput = document.getElementById('usernameInput');
            const passwordInput = document.getElementById('passwordInput');

            const username = usernameInput.value.trim();
            const password = passwordInput.value;

            if (!username || !password) {
                showLoginErrorMessage('Mohon lengkapi User ID dan Password.');
                return;
            }

            const user = appState.allUsers.find(u => u.username === username && u.password === password);

            if (user) {
                if (user.isApproved) {
                    // Perbarui lastLoggedInUsers
                    let lastUsers = appState.lastLoggedInUsers.filter(u => u.uid !== user.uid);
                    lastUsers.unshift({ uid: user.uid, username: user.username });
                    if (lastUsers.length > 5) lastUsers = lastUsers.slice(0, 5);

                    // Atur tab aktif berdasarkan peran/departemen pengguna
                    let initialActiveTab = 'production';
                    let initialActiveProductionSubTab = 'hpp-calculator';
                    let initialWarehouseSubTab = 'inventory-list';
                    let initialReportTab = 'reports-list';

                    if (user.role === 'admin' || user.role === 'super_admin') {
                        initialActiveTab = 'production';
                    } else if (user.department === 'produksi') {
                        initialActiveTab = 'production';
                    } else if (user.department === 'gudang') {
                        initialActiveTab = 'warehouse';
                        initialWarehouseSubTab = 'inventory-list';
                    } else if (user.department === 'penjualan') {
                        initialActiveTab = 'salesCalculator';
                        initialReportTab = 'sales-report';
                    }

                    updateAppState({
                        userId: user.uid,
                        username: user.username,
                        userRole: user.role,
                        userDepartment: user.department,
                        isAuthReady: true,
                        lastLoggedInUsers: lastUsers,
                        activeTab: initialActiveTab,
                        activeProductionSubTab: initialActiveProductionSubTab,
                        warehouse: { ...appState.warehouse, activeSubTab: initialWarehouseSubTab },
                        activeReportTab: initialReportTab,
                    });

                    const motivationalMessages = [
                        `Selamat datang kembali, ${appState.username}! Mari wujudkan ide-ide brilian hari ini!`,
                        `Semangat pagi, ${appState.username}! Siap menciptakan produk berkualitas?`,
                        `Selamat bekerja, ${appState.username}! Setiap detail kecil membawa kita pada kesuksesan besar.`,
                        `Halo, ${appState.username}! Waktunya berinovasi dan berkreasi!`,
                        `Ayo, ${appState.username}! Kita buat hari ini lebih produktif dari kemarin!`
                    ];
                    showCustomMessage(motivationalMessages[Math.floor(Math.random() * motivationalMessages.length)], 'success');
                    addActivityLog('Manajemen Akun', `Pengguna ${user.username} (${formatRole(user.role)}) berhasil login.`, user.uid);

                } else {
                    showLoginErrorMessage('Akun Anda belum disetujui oleh admin.');
                }
            } else {
                showLoginErrorMessage('User ID atau password salah.');
            }
        }

        /**
         * Menangani pendaftaran pengguna baru.
         */
        function handleRegister() {
            const regUsernameInput = document.getElementById('regUsernameInput');
            const regPasswordInput = document.getElementById('regPasswordInput');
            const regEmailInput = document.getElementById('regEmailInput');
            const regWhatsappInput = document.getElementById('regWhatsappInput');
            const regDepartmentInput = document.getElementById('regDepartmentInput');

            const username = regUsernameInput.value.trim();
            const password = regPasswordInput.value;
            const email = regEmailInput.value.trim();
            const whatsapp = regWhatsappInput.value.trim();
            const department = regDepartmentInput.value;

            if (!username || !password || !email || !whatsapp || !department) {
                showLoginErrorMessage('Mohon lengkapi semua kolom.');
                return;
            }
            if (password.length < 6) {
                showLoginErrorMessage('Password harus minimal 6 karakter.');
                return;
            }
            if (appState.allUsers.some(u => u.username === username)) {
                showLoginErrorMessage(`User ID "${username}" sudah terdaftar.`);
                return;
            }

            const newUser = {
                uid: generateUniqueId(),
                username,
                password,
                email,
                whatsapp,
                department,
                role: 'pending',
                isApproved: false,
                createdAt: new Date().toISOString()
            };

            updateAppState({
                allUsers: [...appState.allUsers, newUser],
                loginView: 'login'
            });

            showCustomMessage('Pendaftaran berhasil! Akun Anda menunggu persetujuan admin.', 'success');
            addActivityLog('Manajemen Akun', `Pengguna baru "${username}" mendaftar dan menunggu persetujuan.`, newUser.uid);
        }

        /**
         * Menangani logout pengguna.
         */
        function handleLogout() {
            addActivityLog('Manajemen Akun', `Pengguna ${appState.username} (${formatRole(appState.userRole)}) logout.`, appState.userId);

            localStorage.removeItem('loggedInUser');
            updateAppState({
                userId: null,
                username: null,
                userRole: null,
                userDepartment: null,
                isAuthReady: false,
                loginView: 'login'
            });
        }

        /**
         * Menangani perubahan tipe garmen yang dipilih di kalkulator.
         * @param {string} garmentId - ID garmen yang dipilih.
         */
        function handleGarmentChange(garmentId) {
            const currentPattern = GARMENT_PATTERNS[garmentId];
            const hasModels = !!currentPattern.models;
            const defaultModel = hasModels ? currentPattern.models[0] : null;
            const defaultSize = 'L';
            let defaultDetails = hasModels ? GARMENT_SIZES[garmentId]?.[defaultModel]?.[defaultSize] : GARMENT_SIZES[garmentId]?.[defaultSize];

            updateAppState({
                selectedGarment: garmentId,
                garmentOrder: [{ id: generateUniqueId(), model: defaultModel, size: defaultSize, quantity: 1, details: defaultDetails || {}, color: '', colorHex: '' }],
                hppResult: null,
                showError: false,
                showWarning: false,
            });
        }

        /**
         * Menangani perubahan model untuk item garmen tertentu.
         * @param {string} itemId - ID item garmen.
         * @param {string} newModel - Model baru.
         */
        function handleModelChange(itemId, newModel) {
            const updatedGarmentOrder = appState.garmentOrder.map(item => {
                if (item.id === itemId) {
                    const sizeOptions = GARMENT_SIZES[appState.selectedGarment]?.[newModel];
                    const newSize = sizeOptions ? Object.keys(sizeOptions)[0] : 'S';
                    return { ...item, model: newModel, size: newSize, details: sizeOptions ? GARMENT_SIZES[appState.selectedGarment][newModel][newSize] : {} };
                }
                return item;
            });
            updateAppState({ garmentOrder: updatedGarmentOrder });
        }

        /**
         * Menangani perubahan ukuran untuk item garmen tertentu.
         * @param {string} itemId - ID item garmen.
         * @param {string} newSize - Ukuran baru.
         */
        function handleSizeChange(itemId, newSize) {
            const updatedGarmentOrder = appState.garmentOrder.map(item => {
                if (item.id === itemId) {
                    const sizeDetails = GARMENT_PATTERNS[appState.selectedGarment].models ? GARMENT_SIZES[appState.selectedGarment][item.model]?.[newSize] : GARMENT_SIZES[appState.selectedGarment]?.[newSize];
                    return { ...item, size: newSize, details: sizeDetails || {} };
                }
                return item;
            });
            updateAppState({ garmentOrder: updatedGarmentOrder });
        }

        /**
         * Memperbarui properti item pesanan garmen.
         * @param {string} itemId - ID item garmen.
         * @param {string} key - Kunci properti yang akan diperbarui ('quantity', 'color', 'colorHex' atau kunci detail).
         * @param {string} value - Nilai baru.
         * @param {boolean} isDetail - True jika memperbarui properti detail.
         */
        function handleGarmentOrderChange(itemId, key, value, isDetail = false) {
            const updatedGarmentOrder = appState.garmentOrder.map(item => {
                if (item.id === itemId) {
                    if (isDetail) {
                        return { ...item, details: { ...item.details, [key]: parseFloat(value) || 0 } };
                    }
                    return { ...item, [key]: key === 'quantity' ? parseInt(value) || 0 : value };
                }
                return item;
            });
            updateAppState({ garmentOrder: updatedGarmentOrder }, false); // Tidak perlu render penuh, hanya update state
        }

        /**
         * Menangani perubahan warna (nama) untuk item garmen tertentu.
         * @param {string} itemId - ID item garmen.
         * @param {string} newColorName - Nama warna baru.
         */
        function handleColorChange(itemId, newColorName) {
            const updatedGarmentOrder = appState.garmentOrder.map(item => {
                if (item.id === itemId) {
                    const selectedColor = STANDARD_COLORS.find(color => color.name === newColorName);
                    return { ...item, color: newColorName, colorHex: selectedColor ? selectedColor.hex : '' };
                }
                return item;
            });
            updateAppState({ garmentOrder: updatedGarmentOrder });
        }

        /**
         * Menangani perubahan warna (hex) untuk item garmen tertentu.
         * @param {string} itemId - ID item garmen.
         * @param {string} newColorHex - Kode hex warna baru.
         */
        function handleColorHexChange(itemId, newColorHex) {
            const updatedGarmentOrder = appState.garmentOrder.map(item => {
                if (item.id === itemId) {
                    const selectedColor = STANDARD_COLORS.find(color => color.hex.toLowerCase() === newColorHex.toLowerCase());
                    return { ...item, colorHex: newColorHex, color: selectedColor ? selectedColor.name : '' };
                }
                return item;
            });
            updateAppState({ garmentOrder: updatedGarmentOrder }, false); // Tidak perlu render penuh
        }

        /**
         * Menambahkan item garmen baru ke daftar pesanan.
         */
        function addGarmentItem() {
            const currentPattern = GARMENT_PATTERNS[appState.selectedGarment];
            const hasModels = !!currentPattern.models;
            const defaultModel = hasModels ? currentPattern.models[0] : null;
            const defaultSize = 'L';
            const defaultDetails = hasModels ? GARMENT_SIZES[appState.selectedGarment]?.[defaultModel]?.[defaultSize] : GARMENT_SIZES[appState.selectedGarment]?.[defaultSize];
            updateAppState({
                garmentOrder: [...appState.garmentOrder, { id: generateUniqueId(), model: defaultModel, size: defaultSize, quantity: 1, details: defaultDetails || {}, color: '', colorHex: '' }]
            });
        }

        /**
         * Menghapus item garmen dari daftar pesanan.
         * @param {string} itemId - ID item yang akan dihapus.
         */
        function removeGarmentItem(itemId) {
            if (appState.garmentOrder.length > 1) {
                updateAppState({
                    garmentOrder: appState.garmentOrder.filter(item => item.id !== itemId)
                });
            } else {
                showCustomMessage('Minimal harus ada satu item pesanan.', 'error');
            }
        }

        /**
         * Memperbarui properti item biaya tambahan.
         * @param {number} index - Indeks item dalam array additionalItems.
         * @param {string} field - Bidang yang akan diperbarui ('name', 'cost', 'quantity').
         * @param {string} value - Nilai baru.
         */
        function handleAdditionalItemChange(index, field, value) {
            const updatedAdditionalItems = [...appState.otherCosts.additionalItems];
            if (updatedAdditionalItems[index]) {
                if (field === 'name') { updatedAdditionalItems[index].name = value; }
                else if (field === 'cost') { updatedAdditionalItems[index].cost = parseFloat(value) || 0; }
                else if (field === 'quantity') { updatedAdditionalItems[index].quantity = parseInt(value) || 0; }
            }
            updateAppState({ otherCosts: { ...appState.otherCosts, additionalItems: updatedAdditionalItems } }, false);
        }

        /**
         * Menambahkan item biaya tambahan baru.
         */
        function addAdditionalItem() {
            updateAppState({
                otherCosts: { ...appState.otherCosts, additionalItems: [...appState.otherCosts.additionalItems, { name: '', cost: 0, quantity: 1 }] }
            });
        }

        /**
         * Menghapus item biaya tambahan.
         * @param {number} index - Indeks item yang akan dihapus.
         */
        function removeAdditionalItem(index) {
            const updatedAdditionalItems = [...appState.otherCosts.additionalItems];
            updatedAdditionalItems.splice(index, 1);
            updateAppState({
                otherCosts: { ...appState.otherCosts, additionalItems: updatedAdditionalItems }
            });
        }

        /**
         * Menghitung HPP (Harga Pokok Produksi).
         */
        function handleCalculateHPP() {
            const material = appState.material;
            const otherCosts = appState.otherCosts;
            const profitPercentage = appState.profitPercentage;
            const garmentOrder = appState.garmentOrder;
            const selectedGarment = appState.selectedGarment;

            let newShowError = false;
            let newShowWarning = false;

            let isMaterialInputValid;
            if (appState.materialInputType === 'length') {
                isMaterialInputValid = (material.length > 0 && material.pricePerMeter > 0 && material.gramasi > 0);
            } else if (appState.materialInputType === 'roll') {
                isMaterialInputValid = (material.rollCount > 0 && material.lengthPerRoll > 0 && material.pricePerRoll > 0 && material.gramasi > 0);
            } else {
                isMaterialInputValid = (material.weight > 0 && material.gramasi > 0 && material.pricePerKg > 0);
            }

            const areOtherInputsValid = material.width > 0 && material.wasteFactor >= 0 && profitPercentage >= 0;

            if (!isMaterialInputValid || !areOtherInputsValid) {
                newShowError = true;
                updateAppState({ showError: newShowError, hppResult: null, showWarning: newShowWarning });
                return;
            }

            let totalRawAreaM2 = 0;
            let totalGarments = 0;
            const currentPattern = GARMENT_PATTERNS[selectedGarment];

            const hasInvalidGarmentOrder = garmentOrder.some(item => {
                const detailsValid = item.details && Object.values(item.details).every(val => typeof val === 'number' && val > 0);
                return item.quantity <= 0 || !detailsValid;
            });

            if (garmentOrder.length === 0 || hasInvalidGarmentOrder) {
                newShowError = true;
                updateAppState({ showError: newShowError, hppResult: null, showWarning: newShowWarning });
                return;
            }

            garmentOrder.forEach(item => {
                const validDetails = {};
                for (const key in item.details) {
                    validDetails[key] = parseFloat(item.details[key]) || 0;
                }
                totalRawAreaM2 += currentPattern.calculateMaterialArea(validDetails) * item.quantity;
                totalGarments += item.quantity;
            });

            if (totalGarments === 0) {
                newShowError = true;
                updateAppState({ showError: newShowError, hppResult: null, showWarning: newShowWarning });
                return;
            }

            const effectiveWidthInMeters = (material.width * (material.shape === 'tubular' ? 2 : 1)) * 0.0254;
            let pricePerMeter;

            if (appState.materialInputType === 'length') {
                pricePerMeter = material.pricePerMeter;
            } else if (appState.materialInputType === 'roll') {
                // For roll input, we calculate the price per meter based on price per roll and length per roll
                const totalLength = material.rollCount * material.lengthPerRoll;
                const totalPrice = material.rollCount * material.pricePerRoll;
                pricePerMeter = totalPrice / totalLength;
            } else {
                if (material.gramasi === 0) {
                    newShowError = true;
                    showCustomMessage('Gramasi bahan tidak boleh nol saat input berat.', 'error');
                    updateAppState({ showError: newShowError, hppResult: null, showWarning: newShowWarning });
                    return;
                }
                const areaPerKg = 1000 / material.gramasi;
                const lengthPerKg = areaPerKg / effectiveWidthInMeters;
                if (lengthPerKg === 0) {
                    newShowError = true;
                    showCustomMessage('Perhitungan panjang per kg menghasilkan nol. Periksa lebar bahan atau gramasi.', 'error');
                    updateAppState({ showError: newShowError, hppResult: null, showWarning: newShowWarning });
                    return;
                }
                pricePerMeter = material.pricePerKg / lengthPerKg;
            }

            const totalMaterialUsageMeters = (totalRawAreaM2 * (1 + material.wasteFactor / 100)) / effectiveWidthInMeters;
            const totalMaterialCost = totalMaterialUsageMeters * pricePerMeter;

            const totalAdditionalItemCosts = otherCosts.additionalItems.reduce((acc, item) => acc + (item.cost * item.quantity), 0);
            const totalOtherCosts = (otherCosts.laborCost + otherCosts.overheadCost) * totalGarments + totalAdditionalItemCosts;

            const totalHPP = (totalMaterialCost + totalOtherCosts) / totalGarments;
            const sellingPricePerGarment = totalHPP * (1 + profitPercentage / 100);
            const profitPerGarment = sellingPricePerGarment - totalHPP;

            const averageRawAreaPerGarmentM2 = totalRawAreaM2 / totalGarments;
            const materialNeededPerGarmentMetersWithWaste = (averageRawAreaPerGarmentM2 * (1 + material.wasteFactor / 100)) / effectiveWidthInMeters;
            const materialNeededPerGarmentCm = materialNeededPerGarmentMetersWithWaste * 100;

            updateAppState({
                hppResult: {
                    totalHPP,
                    materialCost: totalMaterialCost,
                    otherCosts: totalOtherCosts,
                    garmentsProduced: totalGarments,
                    totalRawAreaM2,
                    wasteFactor: material.wasteFactor,
                    garmentOrder: JSON.parse(JSON.stringify(garmentOrder)),
                    sellingPricePerGarment,
                    profitPerGarment: profitPerGarment,
                    materialNeededPerGarmentCm: materialNeededPerGarmentMetersWithWaste * 100
                },
                showError: false,
                showWarning: newShowWarning
            });
        }

        /**
         * Menyimpan laporan HPP saat ini.
         */
        function saveReport() {
            if (!appState.hppResult || !appState.userId) {
                showCustomMessage('Tidak ada hasil perhitungan untuk disimpan.', 'error');
                return;
            }

            const isRevision = appState.isCurrentlyRevising;
            const newReportId = generateUniqueId();

            const newReport = {
                id: newReportId,
                hppResult: appState.hppResult,
                material: JSON.parse(JSON.stringify(appState.material)),
                otherCosts: JSON.parse(JSON.stringify(appState.otherCosts)),
                profitPercentage: appState.profitPercentage,
                selectedGarment: appState.selectedGarment,
                timestamp: new Date().toISOString(),
                userId: appState.userId,
                isRevised: isRevision,
                revisionNotes: isRevision ? appState.revisionNotesForNewReport : '',
                originalReportId: isRevision ? appState.originalReportIdForRevision : null,
                isSuperseded: false,
                isWarehouseApproved: false,
                productionRequestId: appState.currentProductionRequestId || null
            };

            const updatedSavedReports = [...appState.savedReports, newReport];
            let logDescription = '';

            if (isRevision && appState.originalReportIdForRevision) {
                const originalReportIndex = updatedSavedReports.findIndex(r => r.id === appState.originalReportIdForRevision);
                if (originalReportIndex !== -1) {
                    updatedSavedReports[originalReportIndex].isSuperseded = true;
                    logDescription = `Laporan HPP #${appState.originalReportIdForRevision.substring(0, 8).toUpperCase()} direvisi menjadi laporan #${newReportId.substring(0, 8).toUpperCase()}. Catatan: "${appState.revisionNotesForNewReport}"`;
                }
            } else {
                logDescription = `Laporan HPP baru untuk ${GARMENT_PATTERNS[newReport.selectedGarment].title} (${newReport.hppResult.garmentsProduced} pcs) dibuat.`;
                if (newReport.productionRequestId) {
                    logDescription += ` (Terkait permintaan produksi #${newReport.productionRequestId.substring(0, 8).toUpperCase()})`;
                }
            }

            updateAppState({
                savedReports: updatedSavedReports,
                hppResult: null,
                isCurrentlyRevising: false,
                originalReportIdForRevision: null,
                revisionNotesForNewReport: '',
                currentProductionRequestId: null,
                activeTab: 'report',
                activeReportTab: 'reports-list'
            });

            showCustomMessage('Laporan produksi berhasil disimpan!', 'success');
            addActivityLog('Produksi', logDescription, appState.userId, newReportId);
        }

        /**
         * Menghapus laporan produksi.
         * @param {string} id - ID laporan yang akan dihapus.
         */
        function removeReport(id) {
            showCustomConfirmation('Apakah Anda yakin ingin menghapus laporan ini? Tindakan ini tidak dapat dibatalkan.', () => {
                const reportToRemove = appState.savedReports.find(report => report.id === id);
                if (reportToRemove) {
                    const canDelete = appState.userRole === 'super_admin' || appState.userRole === 'admin' ||
                                      (appState.userRole === 'member' && reportToRemove.userId === appState.userId);

                    if (!canDelete) {
                        showCustomMessage('Anda tidak memiliki izin untuk menghapus laporan ini.', 'error');
                        return;
                    }

                    const updatedSavedReports = appState.savedReports.filter(report => report.id !== id);
                    const newSelectedReport = (appState.selectedReport && appState.selectedReport.id === id) ? null : appState.selectedReport;

                    updateAppState({
                        savedReports: updatedSavedReports,
                        selectedReport: newSelectedReport
                    });

                    showCustomMessage('Laporan berhasil dihapus.', 'success');
                    addActivityLog('Produksi', `Laporan HPP #${id.substring(0, 8).toUpperCase()} dihapus.`, appState.userId, id);
                }
            });
        }

        /**
         * Memulai proses revisi laporan.
         */
        function handleReviseReport() {
            const revisionModal = document.getElementById('revisionModal');
            const revisionNotesInput = document.getElementById('revisionNotesInput');
            if (!appState.selectedReport) {
                showCustomMessage('Tidak ada laporan dipilih.', 'error');
                return;
            }

            const timeDiffHours = (new Date() - new Date(appState.selectedReport.timestamp)) / (1000 * 60 * 60);
            const isWithin24Hours = timeDiffHours <= 24;

            if (!isWithin24Hours) {
                showCustomMessage('Laporan hanya dapat direvisi dalam waktu 24 jam setelah dibuat.', 'error');
                return;
            }
            if (appState.selectedReport.isRevised) {
                showCustomMessage('Laporan ini sudah pernah direvisi.', 'error');
                return;
            }
            if (appState.selectedReport.isWarehouseApproved) {
                showCustomMessage('Laporan ini sudah disetujui gudang dan tidak dapat direvisi.', 'error');
                return;
            }

            if (revisionModal && revisionNotesInput) {
                revisionNotesInput.value = '';
                revisionModal.classList.remove('hidden');
                const confirmBtn = document.getElementById('confirmRevisionBtn');
                const cancelBtn = document.getElementById('cancelRevisionBtn');

                const handleConfirmRevision = () => {
                    const notes = revisionNotesInput.value.trim();
                    if (!notes) {
                        showCustomMessage('Catatan revisi tidak boleh kosong.', 'error');
                        return;
                    }

                    updateAppState({
                        isCurrentlyRevising: true,
                        originalReportIdForRevision: appState.selectedReport.id,
                        revisionNotesForNewReport: notes,
                        selectedGarment: appState.selectedReport.selectedGarment,
                        material: JSON.parse(JSON.stringify(appState.selectedReport.material)),
                        otherCosts: JSON.parse(JSON.stringify(appState.selectedReport.otherCosts)),
                        profitPercentage: appState.selectedReport.profitPercentage,
                        garmentOrder: JSON.parse(JSON.stringify(appState.selectedReport.hppResult.garmentOrder)),
                        hppResult: null,
                        showError: false,
                        showWarning: false,
                        activeTab: 'production',
                        activeProductionSubTab: 'hpp-calculator',
                    });

                    revisionModal.classList.add('hidden');
                    confirmBtn.removeEventListener('click', handleConfirmRevision);
                    cancelBtn.removeEventListener('click', handleCancelRevision);
                };

                const handleCancelRevision = () => {
                    revisionModal.classList.add('hidden');
                    confirmBtn.removeEventListener('click', handleConfirmRevision);
                    cancelBtn.removeEventListener('click', handleCancelRevision);
                };

                confirmBtn.addEventListener('click', handleConfirmRevision);
                cancelBtn.addEventListener('click', handleCancelRevision);
            }
        }

        /**
         * Menangani penambahan produk dari inventaris ke kalkulator penjualan.
         */
        function handleAddProductToSale() {
            const productSelect = document.getElementById('productSelect');
            if (!productSelect || !productSelect.value) {
                showCustomMessage('Pilih produk terlebih dahulu.', 'error');
                return;
            }

            const selectedInventoryItem = appState.warehouse.inventory.find(item => item.id === productSelect.value);
            if (!selectedInventoryItem) return;

            const updatedSalesItems = [...appState.salesCalculator.items];
            const existingSaleItemIndex = updatedSalesItems.findIndex(item => item.id === selectedInventoryItem.id);

            if (existingSaleItemIndex !== -1) {
                if (updatedSalesItems[existingSaleItemIndex].quantity < selectedInventoryItem.stock) {
                    updatedSalesItems[existingSaleItemIndex].quantity++;
                    showNotification(`Kuantitas ${selectedInventoryItem.name} ditambahkan.`, 'info');
                } else {
                    showCustomMessage('Stok produk tidak mencukupi.', 'error');
                }
            } else {
                if (selectedInventoryItem.stock > 0) {
                    updatedSalesItems.push({
                        id: selectedInventoryItem.id,
                        name: selectedInventoryItem.name,
                        price: selectedInventoryItem.sellingPrice,
                        quantity: 1,
                        maxStock: selectedInventoryItem.stock
                    });
                    showNotification(`${selectedInventoryItem.name} ditambahkan ke keranjang.`, 'success');
                } else {
                    showCustomMessage('Produk ini tidak memiliki stok.', 'error');
                }
            }
            updateAppState({ salesCalculator: { ...appState.salesCalculator, items: updatedSalesItems, result: null } });
        }

        /**
         * Menangani pembaruan kuantitas item penjualan.
         * @param {number} index - Indeks item dalam array salesCalculator.items.
         * @param {number} newQuantity - Kuantitas baru.
         */
        function handleSaleItemQuantityChange(index, newQuantity) {
            const updatedSalesItems = [...appState.salesCalculator.items];
            const item = updatedSalesItems[index];
            if (!item) return;

            newQuantity = parseInt(newQuantity);

            if (isNaN(newQuantity) || newQuantity < 1) {
                newQuantity = 1;
            }

            if (newQuantity > item.maxStock) {
                newQuantity = item.maxStock;
                showCustomMessage(`Stok untuk ${item.name} hanya tersisa ${item.maxStock}.`, 'error');
            }

            item.quantity = newQuantity;
            updateAppState({ salesCalculator: { ...appState.salesCalculator, items: updatedSalesItems, result: null } }, false);

            const inputElement = document.querySelector(`.sale-item-quantity[data-index="${index}"]`);
            if (inputElement) {
                inputElement.value = newQuantity;
            }
        }

        /**
         * Menangani penghapusan item penjualan dari kalkulator penjualan.
         * @param {number} index - Indeks item yang akan dihapus.
         */
        function handleRemoveSaleItem(index) {
            const updatedSalesItems = [...appState.salesCalculator.items];
            updatedSalesItems.splice(index, 1);
            updateAppState({ salesCalculator: { ...appState.salesCalculator, items: updatedSalesItems, result: null } });
        }

        /**
         * Menghitung total jumlah penjualan.
         */
        function handleCalculateSale() {
            const { items, discountType, discountValue, taxPercentage } = appState.salesCalculator;
            if (items.length === 0) {
                showCustomMessage('Tambahkan item ke keranjang terlebih dahulu.', 'error');
                return;
            }

            const subtotal = items.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            let discountAmount = 0;
            if (discountType === 'percentage') {
                discountAmount = subtotal * (discountValue / 100);
            } else {
                discountAmount = discountValue;
            }
            discountAmount = Math.min(discountAmount, subtotal);

            const totalAfterDiscount = subtotal - discountAmount;
            const taxAmount = totalAfterDiscount * (taxPercentage / 100);
            const grandTotal = totalAfterDiscount + taxAmount;

            updateAppState({
                salesCalculator: {
                    ...appState.salesCalculator,
                    result: {
                        subtotal,
                        discountAmount,
                        taxAmount,
                        grandTotal,
                        taxPercentage,
                    }
                }
            });
        }

        /**
         * Menyelesaikan penjualan, memperbarui inventaris, dan menyimpan laporan penjualan.
         */
        function handleFinalizeSale() {
            const { items, customerName, result } = appState.salesCalculator;
            if (!result) {
                showCustomMessage('Harap hitung total penjualan terlebih dahulu.', 'error');
                return;
            }
            if (items.length === 0) {
                showCustomMessage('Tidak ada item dalam penjualan.', 'error');
                return;
            }

            showCustomConfirmation('Apakah Anda yakin ingin menyelesaikan penjualan ini?', () => {
                const newSaleId = generateUniqueId();
                const updatedInventory = [...appState.warehouse.inventory];
                const newStockHistoryEntries = [];

                items.forEach(saleItem => {
                    const inventoryItemIndex = updatedInventory.findIndex(inv => inv.id === saleItem.id);
                    if (inventoryItemIndex !== -1) {
                        const existingItem = updatedInventory[inventoryItemIndex];
                        const oldStock = existingItem.stock;
                        existingItem.stock -= saleItem.quantity;

                        newStockHistoryEntries.unshift({
                            id: generateUniqueId(),
                            timestamp: new Date().toISOString(),
                            productId: saleItem.id,
                            productName: saleItem.name,
                            type: 'Keluar',
                            quantity: saleItem.quantity,
                            finalStock: existingItem.stock,
                            source: `Penjualan Struk #${newSaleId.substring(0, 8).toUpperCase()}`,
                            userId: appState.userId
                        });
                    }
                });

                const newSale = {
                    id: newSaleId,
                    timestamp: new Date().toISOString(),
                    userId: appState.userId,
                    customerName: customerName,
                    items: JSON.parse(JSON.stringify(items)),
                    result: JSON.parse(JSON.stringify(result))
                };

                updateAppState({
                    savedSales: [...appState.savedSales, newSale],
                    warehouse: {
                        ...appState.warehouse,
                        inventory: updatedInventory,
                        stockHistory: [...newStockHistoryEntries, ...appState.warehouse.stockHistory]
                    },
                    salesCalculator: { items: [], customerName: '', discountType: 'percentage', discountValue: 0, taxPercentage: 0, result: null, searchTerm: '', selectedCategoryFilter: 'all' },
                    selectedSale: newSale
                });

                showCustomMessage('Penjualan berhasil disimpan!', 'success');
                printInvoice('sale');
                addActivityLog('Penjualan', `Penjualan baru senilai Rp ${formatRupiah(newSale.result.grandTotal)} kepada ${newSale.customerName || 'Umum'} dicatat.`, appState.userId, newSaleId);
            });
        }

        /**
         * Menangani permintaan produksi untuk produk.
         * @param {string} productId - ID produk.
         */
        function requestProduction(productId) {
            const product = appState.warehouse.inventory.find(item => item.id === productId);
            if (!product) {
                showNotification('Produk tidak ditemukan.', 'error');
                return;
            }

            showModal(`Minta Produksi: ${product.name}`, `
                <div class="space-y-4">
                    <div>
                        <label for="requestQuantity" class="block text-sm font-medium text-gray-700">Jumlah yang Diminta (pcs)</label>
                        <input type="number" id="requestQuantity" min="1" value="10" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border"/>
                    </div>
                    <div>
                        <label for="requestNotes" class="block text-sm font-medium text-gray-700">Catatan (Opsional)</label>
                        <textarea id="requestNotes" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border h-24 resize-y" placeholder="Contoh: Untuk stok akhir tahun..."></textarea>
                    </div>
                    <div class="flex justify-end gap-3">
                        <button id="cancelRequestBtn" class="py-2 px-4 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">Batal</button>
                        <button id="confirmRequestBtn" class="py-2 px-4 bg-indigo-600 text-white rounded-md hover:bg-indigo-700">Kirim Permintaan</button>
                    </div>
                </div>
            `);

            const requestQuantityInput = document.getElementById('requestQuantity');
            const requestNotesInput = document.getElementById('requestNotes');
            const confirmRequestBtn = document.getElementById('confirmRequestBtn');
            const cancelRequestBtn = document.getElementById('cancelRequestBtn');
            const closeModalBtn = document.getElementById('closeModalBtn');

            const handleConfirm = () => {
                const quantity = parseInt(requestQuantityInput.value);
                const notes = requestNotesInput.value.trim();

                if (isNaN(quantity) || quantity <= 0) {
                    showNotification('Jumlah permintaan harus berupa angka positif.', 'error');
                    return;
                }

                const newRequest = {
                    id: generateUniqueId(),
                    timestamp: new Date().toISOString(),
                    productId: product.id,
                    productName: product.name,
                    requestedQuantity: quantity,
                    status: 'pending',
                    requestedBy: appState.userId,
                    notes: notes,
                    approvedByProductionAt: null,
                    completedProductionAt: null,
                    approvedByWarehouseAt: null,
                    productionNotes: ''
                };

                updateAppState({
                    warehouse: {
                        ...appState.warehouse,
                        productionRequests: [newRequest, ...appState.warehouse.productionRequests]
                    }
                });

                showNotification(`Permintaan produksi untuk ${quantity} pcs ${product.name} telah dibuat.`, 'success');
                if (closeModalBtn) closeModalBtn.click();
                addActivityLog('Gudang', `Permintaan produksi untuk ${quantity} pcs "${product.name}" dibuat.`, appState.userId, newRequest.id);
            };

            confirmRequestBtn?.addEventListener('click', handleConfirm);
            cancelRequestBtn?.addEventListener('click', () => { if (closeModalBtn) closeModalBtn.click(); });
        }

        /**
         * Menangani pembaruan status permintaan produksi.
         * @param {string} requestId - ID permintaan.
         * @param {string} newStatus - Status baru ('approved_by_production', 'completed_production', 'approved_by_warehouse', 'rejected').
         */
        function updateProductionRequestStatus(requestId, newStatus) {
            const requestIndex = appState.warehouse.productionRequests.findIndex(r => r.id === requestId);
            if (requestIndex === -1) {
                showNotification('Permintaan produksi tidak ditemukan.', 'error');
                return;
            }

            const updatedRequests = [...appState.warehouse.productionRequests];
            const request = updatedRequests[requestIndex];
            const { userRole, userDepartment } = appState;
            const isAdmin = userRole === 'admin' || userRole === 'super_admin';

            let isValidAction = false;
            let confirmationMessage = '';
            let successMessage = '';
            let activityLogType = '';
            let activityLogDescription = '';
            let newAppStateChanges = {};

            if (newStatus === 'approved_by_production' && request.status === 'pending' && (userDepartment === 'produksi' || isAdmin)) {
                isValidAction = true;
                confirmationMessage = `Apakah Anda yakin ingin menyetujui permintaan produksi ini untuk ${request.productName}? Ini akan mengarahkan Anda ke kalkulator HPP.`;
                successMessage = `Permintaan produksi untuk ${request.productName} telah Anda setujui. Silakan hitung HPP dan simpan laporannya.`;
                activityLogType = 'Produksi';
                activityLogDescription = `Permintaan produksi #${requestId.substring(0, 8).toUpperCase()} untuk "${request.productName}" disetujui oleh produksi.`;

                const productIdParts = request.productId.split('_');
                const garmentType = productIdParts[0];
                const modelName = productIdParts[1] ? productIdParts[1].replace(/-/g, ' ').split(' ').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ') : 'Standard';
                const sizeName = productIdParts[2] ? productIdParts[2].toUpperCase() : 'L';
                const colorName = productIdParts[3] ? productIdParts[3].replace(/-/g, ' ') : '';

                const currentPattern = GARMENT_PATTERNS[garmentType];
                const selectedModel = currentPattern.models ? currentPattern.models.find(m => m.toLowerCase() === modelName.toLowerCase()) : null;
                const sizeDetails = selectedModel ? GARMENT_SIZES[garmentType]?.[selectedModel]?.[sizeName] : GARMENT_SIZES[garmentType]?.[sizeName];
                const selectedColor = STANDARD_COLORS.find(c => c.name.toLowerCase() === colorName.toLowerCase());

                newAppStateChanges = {
                    currentProductionRequestId: request.id,
                    selectedGarment: garmentType,
                    garmentOrder: [{
                        id: generateUniqueId(),
                        model: selectedModel,
                        size: sizeName,
                        quantity: request.requestedQuantity,
                        details: sizeDetails || {},
                        color: selectedColor ? selectedColor.name : colorName,
                        colorHex: selectedColor ? selectedColor.hex : ''
                    }],
                    hppResult: null,
                    showError: false,
                    showWarning: false,
                    activeTab: 'production',
                    activeProductionSubTab: 'hpp-calculator',
                };
                request.approvedByProductionAt = new Date().toISOString();

            } else if (newStatus === 'completed_production' && request.status === 'approved_by_production' && (userDepartment === 'produksi' || isAdmin)) {
                isValidAction = true;
                confirmationMessage = `Apakah Anda yakin produksi untuk ${request.productName} sudah selesai dan siap untuk diserahkan ke gudang?`;
                successMessage = `Produksi untuk permintaan #${requestId.substring(0, 8).toUpperCase()} telah selesai. Menunggu persetujuan gudang.`;
                activityLogType = 'Produksi';
                activityLogDescription = `Produksi untuk permintaan #${requestId.substring(0, 8).toUpperCase()} selesai. Menunggu persetujuan gudang.`;
                request.completedProductionAt = new Date().toISOString();

            } else if (newStatus === 'approved_by_warehouse' && request.status === 'completed_production' && (userDepartment === 'gudang' || isAdmin)) {
                isValidAction = true;
                confirmationMessage = `Apakah Anda yakin ingin menerima barang hasil produksi ${request.productName} (${request.requestedQuantity} pcs) ke gudang?`;
                successMessage = `Barang hasil produksi untuk permintaan #${requestId.substring(0, 8).toUpperCase()} diterima ke gudang. Status permintaan berubah menjadi selesai.`;
                activityLogType = 'Gudang';
                activityLogDescription = `Barang hasil produksi untuk permintaan #${requestId.substring(0, 8).toUpperCase()} diterima ke gudang.`;
                request.approvedByWarehouseAt = new Date().toISOString();

                const relatedHPPReport = appState.savedReports.find(report =>
                    report.productionRequestId === request.id && !report.isSuperseded
                );

                const updatedInventory = [...appState.warehouse.inventory];
                const newStockHistoryEntries = [];

                if (relatedHPPReport) {
                    relatedHPPReport.hppResult.garmentOrder.forEach(orderItem => {
                        const category = relatedHPPReport.selectedGarment;
                        const model = orderItem.model || 'Standard';
                        const size = orderItem.size;
                        const color = orderItem.color || 'Tidak Berwarna';

                        const inventoryId = `${category}_${model.replace(/\s+/g, '-')}_${size}_${color.replace(/\s+/g, '-')}`.toLowerCase();
                        const productName = `${GARMENT_PATTERNS[category].title} ${model} ${size} ${color ? `(${color})` : ''}`;

                        const existingItemIndex = updatedInventory.findIndex(inv => inv.id === inventoryId);

                        let oldStock = 0;
                        let newStockQuantity = orderItem.quantity;

                        if (existingItemIndex > -1) {
                            const existingItem = updatedInventory[existingItemIndex];
                            oldStock = existingItem.stock;
                            const totalOldCost = existingItem.hpp * existingItem.stock;
                            const totalNewCost = relatedHPPReport.hppResult.totalHPP * orderItem.quantity;
                            const newTotalStock = existingItem.stock + orderItem.quantity;

                            existingItem.stock = newTotalStock;
                            existingItem.hpp = newTotalStock > 0 ? (totalOldCost + totalNewCost) / newTotalStock : 0;
                            existingItem.sellingPrice = existingItem.hpp * (1 + (relatedHPPReport.profitPercentage / 100));
                        } else {
                            updatedInventory.push({
                                id: inventoryId,
                                name: productName,
                                category: category,
                                stock: orderItem.quantity,
                                hpp: relatedHPPReport.hppResult.totalHPP,
                                sellingPrice: relatedHPPReport.hppResult.sellingPricePerGarment,
                                sourceReportId: relatedHPPReport.id
                            });
                        }

                        newStockHistoryEntries.unshift({
                            id: generateUniqueId(),
                            timestamp: new Date().toISOString(),
                            productId: inventoryId,
                            productName: productName,
                            type: 'Masuk',
                            quantity: newStockQuantity,
                            finalStock: (existingItemIndex > -1 ? updatedInventory[existingItemIndex].stock : newStockQuantity),
                            source: `Produksi Laporan #${relatedHPPReport.id.substring(0, 8).toUpperCase()}`,
                            userId: appState.userId
                        });
                    });
                    relatedHPPReport.isWarehouseApproved = true;
                    showNotification(`Stok ${request.productName} berhasil ditambahkan ke gudang dari laporan HPP.`, 'success');
                } else {
                    let productInInventory = updatedInventory.find(item => item.id === request.productId);
                    if (productInInventory) {
                        productInInventory.stock += request.requestedQuantity;
                        showNotification(`Stok ${productInInventory.name} berhasil ditambahkan ke gudang (tanpa laporan HPP terkait).`, 'info');
                    } else {
                        const categoryFromId = request.productId.split('_')[0] || 'umum';
                        updatedInventory.push({
                            id: request.productId,
                            name: request.productName,
                            category: categoryFromId,
                            stock: request.requestedQuantity,
                            hpp: 0,
                            sellingPrice: 0,
                            sourceReportId: null
                        });
                        showNotification(`Produk baru ${request.productName} ditambahkan ke gudang dengan stok (tanpa laporan HPP terkait).`, 'info');
                    }

                    newStockHistoryEntries.unshift({
                        id: generateUniqueId(),
                        timestamp: new Date().toISOString(),
                        productId: request.productId,
                        productName: request.productName,
                        type: 'Masuk (Produksi)',
                        quantity: request.requestedQuantity,
                        finalStock: updatedInventory.find(item => item.id === request.productId)?.stock || request.requestedQuantity,
                        source: `Permintaan Produksi #${requestId.substring(0, 8).toUpperCase()}`,
                        userId: appState.userId
                    });
                }
                newAppStateChanges = {
                    warehouse: {
                        ...appState.warehouse,
                        inventory: updatedInventory,
                        stockHistory: [...newStockHistoryEntries, ...appState.warehouse.stockHistory]
                    }
                };

            } else if (newStatus === 'rejected' && (request.status === 'pending' || request.status === 'approved_by_production') && (userDepartment === 'produksi' || isAdmin)) {
                isValidAction = true;
                confirmationMessage = `Apakah Anda yakin ingin menolak permintaan produksi ini untuk ${request.productName}?`;
                successMessage = `Permintaan produksi ${request.productName} telah ditolak.`;
                activityLogType = 'Produksi';
                activityLogDescription = `Permintaan produksi #${requestId.substring(0, 8).toUpperCase()} untuk "${request.productName}" ditolak.`;

            } else {
                showNotification('Aksi tidak valid untuk status permintaan saat ini atau peran pengguna Anda.', 'error');
                return;
            }

            showCustomConfirmation(confirmationMessage, () => {
                request.status = newStatus;
                updateAppState({
                    warehouse: {
                        ...appState.warehouse,
                        productionRequests: updatedRequests
                    },
                    ...newAppStateChanges
                });
                showNotification(successMessage, 'success');
                addActivityLog(activityLogType, activityLogDescription, appState.userId, requestId);
            });
        }

        /**
         * Menangani penghapusan permintaan produksi.
         * @param {string} requestId - ID permintaan yang akan dihapus.
         */
        function deleteProductionRequest(requestId) {
            showCustomConfirmation('Apakah Anda yakin ingin menghapus permintaan produksi ini? Tindakan ini tidak dapat dibatalkan.', () => {
                const requestToDelete = appState.warehouse.productionRequests.find(r => r.id === requestId);
                if (requestToDelete) {
                    const { userRole, userDepartment } = appState;
                    const isAdmin = userRole === 'admin' || userRole === 'super_admin';

                    const canDelete = isAdmin ||
                                     (userDepartment === 'gudang' && requestToDelete.requestedBy === appState.userId && (requestToDelete.status === 'pending' || requestToDelete.status === 'rejected')) ||
                                     (userDepartment === 'produksi' && requestToDelete.status === 'rejected');

                    if (!canDelete) {
                        showCustomMessage('Anda tidak memiliki izin untuk menghapus permintaan ini.', 'error');
                        return;
                    }

                    const updatedRequests = appState.warehouse.productionRequests.filter(r => r.id !== requestId);
                    updateAppState({
                        warehouse: {
                            ...appState.warehouse,
                            productionRequests: updatedRequests
                        }
                    });
                    showNotification('Permintaan produksi telah dihapus.', 'success');
                    addActivityLog('Gudang', `Permintaan produksi #${requestId.substring(0, 8).toUpperCase()} untuk "${requestToDelete.productName}" dihapus.`, appState.userId, requestId);
                }
            });
        }

        /**
         * Menyetujui akun pengguna yang tertunda.
         * @param {string} uid - UID pengguna yang akan disetujui.
         */
        function approveUser(uid) {
            if (appState.userRole !== 'admin' && appState.userRole !== 'super_admin') {
                showCustomMessage('Anda tidak memiliki izin.', 'error');
                return;
            }
            showCustomConfirmation('Apakah Anda yakin ingin menyetujui akun ini?', () => {
                const updatedUsers = appState.allUsers.map(u => {
                    if (u.uid === uid) {
                        return { ...u, isApproved: true, role: 'member' };
                    }
                    return u;
                });
                const approvedUser = updatedUsers.find(u => u.uid === uid);
                updateAppState({ allUsers: updatedUsers });
                showCustomMessage('Akun disetujui.', 'success');
                addActivityLog('Manajemen Akun', `Akun "${approvedUser.username}" disetujui dan diatur sebagai ${formatRole(approvedUser.role)}.`, appState.userId, approvedUser.uid);
            });
        }

        /**
         * Menolak dan menghapus akun pengguna yang tertunda.
         * @param {string} uid - UID pengguna yang akan ditolak.
         */
        function rejectUser(uid) {
            if (appState.userRole !== 'admin' && appState.userRole !== 'super_admin') {
                showCustomMessage('Anda tidak memiliki izin.', 'error');
                return;
            }
            if (uid === appState.userId) {
                showCustomMessage('Anda tidak dapat menghapus akun sendiri.', 'error');
                return;
            }
            showCustomConfirmation('Apakah Anda yakin ingin menolak dan menghapus akun ini?', () => {
                const rejectedUser = appState.allUsers.find(u => u.uid === uid);
                const updatedUsers = appState.allUsers.filter(u => u.uid !== uid);
                updateAppState({ allUsers: updatedUsers });
                showCustomMessage('Akun ditolak dan dihapus.', 'success');
                addActivityLog('Manajemen Akun', `Akun "${rejectedUser.username}" ditolak dan dihapus.`, appState.userId, rejectedUser.uid);
            });
        }

        /**
         * Mengubah departemen pengguna.
         * @param {string} uid - UID pengguna.
         * @param {string} newDepartment - Departemen baru.
         */
        function changeUserDepartment(uid, newDepartment) {
            if (appState.userRole !== 'admin' && appState.userRole !== 'super_admin') {
                showCustomMessage('Anda tidak memiliki izin untuk mengubah departemen.', 'error');
                return;
            }
            const userToChange = appState.allUsers.find(u => u.uid === uid);
            if (!userToChange) return;

            if (appState.userRole === 'admin' && userToChange.role !== 'member') {
                showCustomMessage('Wakil CEO hanya dapat mengubah departemen anggota.', 'error');
                return;
            }

            showCustomConfirmation(`Ubah departemen pengguna ini menjadi ${formatDepartment(newDepartment)}?`, () => {
                const updatedUsers = appState.allUsers.map(u => {
                    if (u.uid === uid) {
                        const oldDepartment = u.department;
                        addActivityLog('Manajemen Akun', `Departemen pengguna "${u.username}" diubah dari ${formatDepartment(oldDepartment)} menjadi ${formatDepartment(newDepartment)}.`, appState.userId, u.uid);
                        return { ...u, department: newDepartment };
                    }
                    return u;
                });
                updateAppState({ allUsers: updatedUsers });
                showCustomMessage(`Departemen berhasil diubah.`, 'success');
            });
        }

        /**
         * Mengubah peran pengguna.
         * @param {string} uid - UID pengguna.
         * @param {string} newRole - Peran baru.
         */
        function changeUserRole(uid, newRole) {
            if (appState.userRole !== 'super_admin') {
                showCustomMessage('Hanya CEO yang dapat mengubah peran.', 'error');
                return;
            }
            if (uid === appState.userId) {
                showCustomMessage('Anda tidak dapat mengubah peran sendiri.', 'error');
                return;
            }
            showCustomConfirmation(`Ubah peran pengguna ini menjadi ${formatRole(newRole)}?`, () => {
                const updatedUsers = appState.allUsers.map(u => {
                    if (u.uid === uid) {
                        const oldRole = u.role;
                        const updatedUser = { ...u, role: newRole };
                        if (newRole === 'admin' || newRole === 'super_admin') {
                            updatedUser.department = null;
                        } else {
                            if (!updatedUser.department) {
                                updatedUser.department = 'produksi';
                            }
                        }
                        addActivityLog('Manajemen Akun', `Peran pengguna "${u.username}" diubah dari ${formatRole(oldRole)} menjadi ${formatRole(newRole)}.`, appState.userId, u.uid);
                        return updatedUser;
                    }
                    return u;
                });
                updateAppState({ allUsers: updatedUsers });
                showCustomMessage(`Peran berhasil diubah.`, 'success');
            });
        }

        // =====================================================================================================
        // BAGIAN 7: EVENT LISTENER DELEGATION (Pusat Penanganan Event)
        // =====================================================================================================

        // Objek untuk menyimpan referensi handler agar bisa dihapus
        const eventHandlers = {};

        /**
         * Melampirkan semua event listener yang diperlukan ke DOM.
         * Fungsi ini dipanggil setelah setiap render UI untuk memastikan listener dilampirkan kembali ke elemen baru.
         */
        function attachEventListeners() {
            // Hapus listener sebelumnya untuk mencegah duplikasi
            if (eventHandlers.globalClick) {
                document.body.removeEventListener('click', eventHandlers.globalClick);
            }
            if (eventHandlers.globalChange) {
                document.body.removeEventListener('change', eventHandlers.globalChange);
            }
            if (eventHandlers.globalInput) {
                document.body.removeEventListener('input', eventHandlers.globalInput);
            }
            if (eventHandlers.globalKeydown) {
                document.body.removeEventListener('keydown', eventHandlers.globalKeydown);
            }

            // Simpan referensi handler baru
            eventHandlers.globalClick = handleGlobalClick;
            eventHandlers.globalChange = handleGlobalChange;
            eventHandlers.globalInput = handleGlobalInput;
            eventHandlers.globalKeydown = handleGlobalKeydown;

            // Lampirkan listener delegasi global
            document.body.addEventListener('click', eventHandlers.globalClick);
            document.body.addEventListener('change', eventHandlers.globalChange);
            document.body.addEventListener('input', eventHandlers.globalInput);
            document.body.addEventListener('keydown', eventHandlers.globalKeydown);
        }

        /**
         * Mengekspor rekap stok ke format Excel
         */
        function exportStockHistoryToExcel() {
            const { stockHistory, inventory } = appState;
            
            // Gabungkan data stok dengan informasi inventaris
            const stockWithStatus = stockHistory.map(entry => {
                const inventoryItem = inventory.find(item => item.id === entry.productId);
                let status = 'Aman';
                
                if (inventoryItem) {
                    if (inventoryItem.stock === 0) {
                        status = 'Habis';
                    } else if (inventoryItem.stock <= 10) {
                        status = 'Hampir Habis';
                    }
                }
                
                return {
                    ...entry,
                    status,
                    productName: entry.productName,
                    category: inventoryItem ? inventoryItem.category : 'Tidak Diketahui'
                };
            });
            
            // Buat data untuk CSV
            let csvContent = "data:text/csv;charset=utf-8,";
            
            // Header
            csvContent += "Tanggal,Produk,Kategori,Jenis,Jumlah,Stok Akhir,Status,Sumber,Oleh\n";
            
            // Data
            stockWithStatus.forEach(entry => {
                const row = [
                    `"${new Date(entry.timestamp).toLocaleString('id-ID')}"`,
                    `"${entry.productName}"`,
                    `"${formatDepartment(entry.category)}"`,
                    `"${entry.type}"`,
                    entry.quantity,
                    entry.finalStock,
                    `"${entry.status}"`,
                    `"${entry.source}"`,
                    `"${getUsernameById(entry.userId)}"`
                ].join(",");
                csvContent += row + "\n";
            });
            
            // Buat dan unduh file
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "rekap_stok_kazumi.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showNotification('Rekap stok berhasil diekspor ke Excel', 'success');
        }

        /**
         * Penanganan event klik global menggunakan delegasi.
         * @param {Event} e - Event klik.
         */
        function handleGlobalClick(e) {
            // --- Autentikasi ---
            if (!appState.isAuthReady) {
                if (e.target.id === 'loginBtn') handleLogin();
                else if (e.target.id === 'switchToRegisterBtn') updateAppState({ loginView: 'register' });
                else if (e.target.id === 'registerBtn') handleRegister();
                else if (e.target.id === 'switchToLoginBtn') updateAppState({ loginView: 'login' });
                else if (e.target.classList.contains('last-user-btn')) {
                    const usernameInput = document.getElementById('usernameInput');
                    const passwordInput = document.getElementById('passwordInput');
                    if (usernameInput) usernameInput.value = e.target.dataset.username;
                    if (passwordInput) {
                        passwordInput.value = '';
                        passwordInput.focus();
                    }
                }
                return;
            }

            // --- Logout ---
            if (e.target.id === 'logoutBtn') handleLogout();

            // --- Navigasi Tab Utama ---
            const tabButtons = {
                'production': 'productionTabBtn',
                'salesCalculator': 'salesCalculatorTabBtn',
                'warehouse': 'warehouseTabBtn',
                'report': 'reportTabBtn',
                'accountManagement': 'accountManagementTabBtn',
                'activityLogs': 'activityLogsTabBtn'
            };
            for (const [tabName, btnId] of Object.entries(tabButtons)) {
                if (e.target.id === btnId) {
                    if (appState.activeTab === tabName) return;

                    const currentContent = document.querySelector(`.tab-content.active`);
                    if (currentContent) {
                        currentContent.classList.remove('active');
                    }

                    setTimeout(() => {
                        updateAppState({
                            activeTab: tabName,
                            activeProductionSubTab: tabName === 'production' ? 'hpp-calculator' : appState.activeProductionSubTab,
                            warehouse: { ...appState.warehouse, activeSubTab: tabName === 'warehouse' ? 'inventory-list' : appState.warehouse.activeSubTab },
                            selectedReport: null,
                            selectedSale: null,
                        });
                    }, 150);
                    return;
                }
            }

            // --- Spesifik Tab Produksi (Sub-tab & Kalkulator HPP) ---
            if (appState.activeTab === 'production') {
                if (e.target.id === 'hppCalculatorSubTabBtn') updateAppState({ activeProductionSubTab: 'hpp-calculator' });
                else if (e.target.id === 'productionRequestsSubTabBtn') updateAppState({ activeProductionSubTab: 'production-requests' });
                else if (e.target.closest('button[data-garment-id]')) handleGarmentChange(e.target.closest('button[data-garment-id]').dataset.garmentId);
                else if (e.target.id === 'shapeTubularBtn') updateAppState({ material: { ...appState.material, shape: 'tubular' } });
                else if (e.target.id === 'shapeOpenWideBtn') updateAppState({ material: { ...appState.material, shape: 'open-wide' } });
                   else if (e.target.id === 'inputLengthBtn') updateAppState({ materialInputType: 'length' });
                   else if (e.target.id === 'inputWeightBtn') updateAppState({ materialInputType: 'weight' });
                   else if (e.target.id === 'inputRollBtn') updateAppState({ materialInputType: 'roll' });
                   else if (e.target.id === 'addGarmentItemBtn') addGarmentItem();
                else if (e.target.classList.contains('remove-item-btn')) removeGarmentItem(e.target.dataset.id);
                else if (e.target.id === 'addAdditionalItemBtn') addAdditionalItem();
                else if (e.target.classList.contains('remove-additional-item-btn')) removeAdditionalItem(parseInt(e.target.dataset.index));
                else if (e.target.id === 'calculateHPPBtn') handleCalculateHPP();
                else if (e.target.id === 'saveReportBtn') saveReport();
                // Tombol refresh permintaan produksi di tab produksi
                else if (e.target.id === 'refreshProductionRequestsBtn') { renderProductionSubContent(); showNotification('Daftar permintaan produksi diperbarui', 'info'); }
            }

            // --- Spesifik Tab Kalkulator Penjualan ---
            if (appState.activeTab === 'salesCalculator') {
                if (e.target.id === 'addProductToSaleBtn') handleAddProductToSale();
                else if (e.target.id === 'calculateSaleBtn') handleCalculateSale();
                else if (e.target.id === 'finalizeSaleBtn') handleFinalizeSale();
                else if (e.target.classList.contains('remove-sale-item-btn')) handleRemoveSaleItem(parseInt(e.target.dataset.index));
            }

            // --- Spesifik Tab Gudang ---
            if (appState.activeTab === 'warehouse') {
                if (e.target.id === 'inventoryListTabBtn') updateAppState({ warehouse: { ...appState.warehouse, activeSubTab: 'inventory-list' } });
                else if (e.target.id === 'productionRequestsWarehouseTabBtn') updateAppState({ warehouse: { ...appState.warehouse, activeSubTab: 'production-requests-warehouse' } });
                else if (e.target.id === 'stockHistoryTabBtn') updateAppState({ warehouse: { ...appState.warehouse, activeSubTab: 'stock-history' } });
                // Tombol "Minta Produksi" di tab Inventaris Gudang
                else if (e.target.classList.contains('request-production-btn')) requestProduction(e.target.dataset.id);
                // Filter kategori untuk permintaan produksi di gudang
                else if (e.target.id === 'productionRequestCategoryFilter') {
                    updateAppState({ 
                        warehouse: { 
                            ...appState.warehouse, 
                            selectedCategoryFilter: e.target.value 
                        } 
                    });
                }
                // Ekspor rekap stok ke Excel
                else if (e.target.id === 'exportStockHistoryBtn') exportStockHistoryToExcel();
            }

            // --- Spesifik Tab Laporan ---
            if (appState.activeTab === 'report') {
                if (e.target.id === 'reportsListTabBtn') updateAppState({ activeReportTab: 'reports-list', selectedReport: null, selectedSale: null });
                else if (e.target.id === 'salesReportTabBtn') updateAppState({ activeReportTab: 'sales-report', selectedReport: null, selectedSale: null });
                else if (e.target.id === 'financialRecapTabBtn') updateAppState({ activeReportTab: 'financial-recap', selectedReport: null, selectedSale: null });
                else if (e.target.id === 'productVisTabBtn') updateAppState({ activeReportTab: 'product-vis', selectedReport: null, selectedSale: null });
                else if (e.target.classList.contains('view-detail-btn')) updateAppState({ selectedReport: appState.savedReports.find(r => r.id === e.target.dataset.id) });
                else if (e.target.classList.contains('view-sale-detail-btn')) updateAppState({ selectedSale: appState.savedSales.find(s => s.id === e.target.dataset.id) });
                else if (e.target.classList.contains('remove-report-btn')) removeReport(e.target.dataset.id);
                else if (e.target.id === 'backToReportListBtn') updateAppState({ selectedReport: null, selectedSale: null });
                else if (e.target.id === 'reviseReportBtn') handleReviseReport();
                else if (e.target.id === 'printInvoiceBtn') printInvoice(e.target.dataset.type);
                else if (e.target.id === 'resetFilterBtn') updateAppState({ startDate: '', endDate: '' });
            }

            // --- Spesifik Tab Manajemen Akun ---
            if (appState.activeTab === 'accountManagement' && (appState.userRole === 'admin' || appState.userRole === 'super_admin')) {
                if (e.target.classList.contains('approve-user-btn')) approveUser(e.target.dataset.uid);
                else if (e.target.classList.contains('reject-user-btn')) rejectUser(e.target.dataset.uid);
                else if (e.target.classList.contains('delete-user-btn')) rejectUser(e.target.dataset.uid);
            }

            // --- Penanganan Aksi Permintaan Produksi (Global) ---
            // Pindahkan penanganan ini ke luar blok tab spesifik agar berfungsi di mana saja
            // `renderProductionRequests` dipanggil (Produksi atau Gudang)
            if (e.target.classList.contains('update-request-status-btn')) {
                updateProductionRequestStatus(e.target.dataset.id, e.target.dataset.status);
            }
            if (e.target.classList.contains('delete-request-btn')) {
                deleteProductionRequest(e.target.dataset.id);
            }
            if (e.target.classList.contains('view-request-notes-btn')) {
                const requestId = e.target.dataset.id;
                const request = appState.warehouse.productionRequests.find(r => r.id === requestId);
                if (request) {
                    const notes = request.notes || 'Tidak ada catatan';
                    showModal(`Catatan Permintaan: ${request.productName}`, `
                        <div class="p-4 bg-gray-50 rounded-lg mb-4">
                            <p class="text-gray-700">${notes}</p>
                        </div>
                        <div class="mt-2 text-sm text-gray-500">
                            <p>Diminta pada: ${new Date(request.timestamp).toLocaleString('id-ID')}</p>
                            <p>Status: ${request.status}</p>
                        </div>
                    `);
                }
            }
        }

        /**
         * Penanganan event perubahan global menggunakan delegasi.
         * @param {Event} e - Event perubahan.
         */
        function handleGlobalChange(e) {
            // --- Produksi ---
            if (appState.activeTab === 'production' && appState.activeProductionSubTab === 'hpp-calculator') {
                if (e.target.classList.contains('model-select')) handleModelChange(e.target.dataset.id, e.target.value);
                else if (e.target.classList.contains('size-select')) handleSizeChange(e.target.dataset.id, e.target.value);
                else if (e.target.classList.contains('color-select')) handleColorChange(e.target.dataset.id, e.target.value);
            }

            // --- Penjualan ---
            if (appState.activeTab === 'salesCalculator') {
                if (e.target.classList.contains('sale-item-quantity')) handleSaleItemQuantityChange(parseInt(e.target.dataset.index), parseInt(e.target.value));
                else if (e.target.id === 'salesCategoryFilter') updateAppState({ salesCalculator: { ...appState.salesCalculator, selectedCategoryFilter: e.target.value } });
                else if (e.target.id === 'discountType') updateAppState({ salesCalculator: { ...appState.salesCalculator, discountType: e.target.value, result: null } });
            }

            // --- Gudang ---
            if (appState.activeTab === 'warehouse') {
                if (e.target.id === 'categoryFilter') updateAppState({ warehouse: { ...appState.warehouse, selectedCategoryFilter: e.target.value } });
                else if (e.target.id === 'stockStatusFilter') updateAppState({ warehouse: { ...appState.warehouse, selectedStockStatusFilter: e.target.value } });
            }

            // --- Laporan ---
            if (appState.activeTab === 'report') {
                if (e.target.id === 'startDate') updateAppState({ startDate: e.target.value });
                else if (e.target.id === 'endDate') updateAppState({ endDate: e.target.value });
            }

            // --- Manajemen Akun ---
            if (appState.activeTab === 'accountManagement' && (appState.userRole === 'admin' || appState.userRole === 'super_admin')) {
                if (e.target.classList.contains('change-department-select')) changeUserDepartment(e.target.dataset.uid, e.target.value);
                else if (e.target.classList.contains('change-role-select')) changeUserRole(e.target.dataset.uid, e.target.value);
            }
        }

        /**
         * Penanganan event input global menggunakan delegasi.
         * @param {Event} e - Event input.
         */
        function handleGlobalInput(e) {
            // --- Produksi ---
            if (appState.activeTab === 'production' && appState.activeProductionSubTab === 'hpp-calculator') {
                if (e.target.id === 'materialWidth') updateAppState({ material: { ...appState.material, width: parseFloat(e.target.value) || 0 } }, false);
                else if (e.target.id === 'wasteFactor') updateAppState({ material: { ...appState.material, wasteFactor: parseFloat(e.target.value) || 0 } }, false);
                else if (e.target.id === 'materialLength') updateAppState({ material: { ...appState.material, length: parseFloat(e.target.value) || 0 } }, false);
                else if (e.target.id === 'materialGramasi') updateAppState({ material: { ...appState.material, gramasi: parseFloat(e.target.value) || 0 } }, false);
                else if (e.target.id === 'pricePerMeter') updateAppState({ material: { ...appState.material, pricePerMeter: parseFloat(e.target.value) || 0 } }, false);
                else if (e.target.id === 'materialWeight') updateAppState({ material: { ...appState.material, weight: parseFloat(e.target.value) || 0 } }, false);
                else if (e.target.id === 'pricePerKg') updateAppState({ material: { ...appState.material, pricePerKg: parseFloat(e.target.value) || 0 } }, false);
               else if (e.target.id === 'materialRollCount') updateAppState({ material: { ...appState.material, rollCount: parseFloat(e.target.value) || 0 } }, false);
               else if (e.target.id === 'materialLengthPerRoll') updateAppState({ material: { ...appState.material, lengthPerRoll: parseFloat(e.target.value) || 0 } }, false);
               else if (e.target.id === 'pricePerRoll') updateAppState({ material: { ...appState.material, pricePerRoll: parseFloat(e.target.value) || 0 } }, false);
               else if (e.target.classList.contains('quantity-input')) handleGarmentOrderChange(e.target.dataset.id, 'quantity', e.target.value);
                else if (e.target.classList.contains('detail-input')) handleGarmentOrderChange(e.target.dataset.id, e.target.dataset.detailId, e.target.value, true);
                else if (e.target.classList.contains('color-hex-input')) handleColorHexChange(e.target.dataset.id, e.target.value);
                else if (e.target.id === 'laborCost') updateAppState({ otherCosts: { ...appState.otherCosts, laborCost: parseFloat(e.target.value) || 0 } }, false);
                else if (e.target.id === 'overheadCost') updateAppState({ otherCosts: { ...appState.otherCosts, overheadCost: parseFloat(e.target.value) || 0 } }, false);
                else if (e.target.classList.contains('item-name-input')) handleAdditionalItemChange(parseInt(e.target.dataset.index), 'name', e.target.value);
                else if (e.target.classList.contains('item-cost-input')) handleAdditionalItemChange(parseInt(e.target.dataset.index), 'cost', e.target.value);
                else if (e.target.classList.contains('item-quantity-input')) handleAdditionalItemChange(parseInt(e.target.dataset.index), 'quantity', e.target.value);
                else if (e.target.id === 'profitPercentage') updateAppState({ profitPercentage: parseFloat(e.target.value) || 0 }, false);
            }

            // --- Penjualan ---
            if (appState.activeTab === 'salesCalculator') {
                if (e.target.id === 'salesProductSearch') updateAppState({ salesCalculator: { ...appState.salesCalculator, searchTerm: e.target.value } });
                else if (e.target.id === 'customerName') updateAppState({ salesCalculator: { ...appState.salesCalculator, customerName: e.target.value } }, false);
                else if (e.target.id === 'discountValue') updateAppState({ salesCalculator: { ...appState.salesCalculator, discountValue: parseFloat(e.target.value) || 0, result: null } }, false);
                else if (e.target.id === 'taxPercentage') updateAppState({ salesCalculator: { ...appState.salesCalculator, taxPercentage: parseFloat(e.target.value) || 0, result: null } }, false);
            }

            // --- Gudang ---
            if (appState.activeTab === 'warehouse') {
                if (e.target.id === 'warehouseSearch') updateAppState({ warehouse: { ...appState.warehouse, searchTerm: e.target.value } });
            }

            // --- Modal Revisi ---
            if (e.target.id === 'revisionNotesInput') updateAppState({ revisionNotesForNewReport: e.target.value }, false);
        }

        /**
         * Penanganan event keydown global (misal untuk Enter di input).
         * @param {Event} e - Event keydown.
         */
        function handleGlobalKeydown(e) {
            if (!appState.isAuthReady && e.key === 'Enter') {
                if (e.target.id === 'usernameInput' || e.target.id === 'passwordInput') {
                    handleLogin();
                } else if (e.target.id === 'regUsernameInput' || e.target.id === 'regPasswordInput' || e.target.id === 'regEmailInput' || e.target.id === 'regWhatsappInput') {
                    handleRegister();
                }
            }
        }

        // =====================================================================================================
        // BAGIAN 8: INISIALISASI APLIKASI
        // =====================================================================================================

        /**
         * Menginisialisasi aplikasi saat DOM siap.
         */
        document.addEventListener('DOMContentLoaded', () => {
            // Inisialisasi garmentOrder untuk kalkulator jika belum diatur
            if (!appState.garmentOrder || appState.garmentOrder.length === 0) {
                const currentPattern = GARMENT_PATTERNS[appState.selectedGarment];
                const hasModels = !!currentPattern.models;
                const defaultModel = hasModels ? currentPattern.models[0] : null;
                const defaultSize = 'L';
                const defaultDetails = hasModels ? GARMENT_SIZES[appState.selectedGarment]?.[defaultModel]?.[defaultSize] : GARMENT_SIZES[appState.selectedGarment]?.[defaultSize];
                updateAppState({ garmentOrder: [{ id: generateUniqueId(), model: defaultModel, size: defaultSize, quantity: 1, details: defaultDetails || {}, color: '', colorHex: '' }] }, false);
            }

            filterReports(); // Filter laporan awal
            window.renderApp(); // Panggil render utama untuk pertama kali
        });
    </script>
</body>
</html>
